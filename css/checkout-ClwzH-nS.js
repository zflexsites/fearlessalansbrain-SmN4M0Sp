import{g as R,a as _,e as j,c as F,i as G,b as U,d as J,n as K}from"./app-Bjfy8Y7s.js";function V(){try{const e=document.getElementById("zflex-data")||document.querySelector(".zflex-fragment-data");return!e||!e.textContent?(console.warn("[Checkout] Tunnel de data est vide ou introuvable."),{}):JSON.parse(e.textContent)}catch(e){return console.error("[Checkout] Erreur de parsing du tunnel de data:",e),{}}}function Q(){return Math.random().toString(36).slice(2,9)}function W(e){return`${e}-${Date.now()}-${Q()}`}function D(e){return e==null?"":String(e)}function X(e){if(e){if(typeof e.transactionStatus=="string")return e.transactionStatus;if(e.result&&typeof e.result.transactionStatus=="string")return e.result.transactionStatus;if(e.data&&typeof e.data.transactionStatus=="string")return e.data.transactionStatus;if(typeof e.status=="string")return e.status}}function Y(e){if(e)return e.error||e.message||e.result?.error||e.result?.message||e.data?.error}function Z(e){const t=document.getElementById("summary-items-list"),u=document.getElementById("summary-subtotal"),b=document.getElementById("summary-total");if(!t||!u||!b)return;if(!e||e.length===0){t.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>',u.innerHTML="",b.innerHTML="";return}t.innerHTML="";const x={};e.forEach(g=>{const C=document.createElement("div");C.className="flex justify-between items-center text-sm mb-4";const L=g.coverImage||"https://via.placeholder.com/64?text=No+Image",f=g.title||"Produit",y=g.price?.amount||0,I=g.price?.currency||"EUR",l=g.quantity||1;C.innerHTML=`
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 flex-shrink-0 border rounded overflow-hidden" style="border-color: var(--card-border-color);">
          <img src="${L}" alt="${f}" class="w-full h-full object-cover">
        </div>
        <div>
          <div class="font-medium" style="color: var(--text-color);">
            <span class="font-bold text-xs px-1 py-0.5 rounded mr-1" style="background-color: var(--card-bg-color);">${l}x</span> 
            ${f}
          </div>
        </div>
      </div>
      <span class="font-medium whitespace-nowrap ml-2" style="color: var(--text-color);">
        ${(y*l).toFixed(2)} ${I}
      </span>
    `,t.appendChild(C),x[I]||(x[I]=0),x[I]+=y*l}),u.innerHTML="",b.innerHTML="",Object.entries(x).forEach(([g,C])=>{const L=`${Number(C).toFixed(2)} ${g}`;u.innerHTML+=`<div style="color: var(--text-color);">${L}</div>`,b.innerHTML+=`<div style="color: var(--text-color);">${L}</div>`})}function te(){const e=document.getElementById("checkout-form");if(!e)return{destroy:()=>{}};const t=document.getElementById("checkout-error");let u=null;const b=async s=>{const i=localStorage.getItem("zflex_prospectId");if(!(!i||!s))try{const r=await _(s,i);r.success&&r.data&&j.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"On vous reconnaît !",message:"Voulez-vous utiliser les informations de votre dernière visite ?",messageHtml:`
                <div style="display:flex;gap:12px;align-items:center">
                  <div style="width:56px;height:56px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:600;color:#111">${(r.data.name||"U").charAt(0)}</div>
                  <div>
                    <div>Nom: <strong>${D(r.data.name)}</strong></div>
                    <div>Tél: <strong>${D(r.data.phone)}</strong></div>
                    <div style="color:#6b7280">${D(r.data.address)}</div>
                  </div>
                </div>
              `,confirmText:"Oui, utiliser",cancelText:"Non, merci",variant:"info",onConfirm:()=>{const n=e.elements;n.name&&(n.name.value=r.data?.name||""),n.email&&(n.email.value=r.data?.email||""),n.phone&&(n.phone.value=r.data?.phone||""),n.address&&(n.address.value=r.data?.address||""),n.notes&&(n.notes.value=r.data?.notes||"")}}}))}catch(r){console.warn("Impossible de récupérer les infos du prospect/client:",r?.message||r),String(r?.message||"").includes("Aucune information")&&localStorage.removeItem("zflex_prospectId")}},x=V().storeId;if(!x){console.error("[Checkout] Erreur critique : ID du store non trouvé à l'initialisation.");const s=document.querySelector(".lg\\:col-span-3");s&&(s.innerHTML='<div class="text-red-500 p-4 border border-red-200 rounded-lg bg-red-50"><strong>Erreur de chargement.</strong> Impossible de récupérer les informations de la boutique. Veuillez rafraîchir la page.</div>');return}b(x);const g=R()||[];Z(g);const C=document.getElementById("step-address"),L=document.getElementById("step-payment"),f=document.getElementById("continue-to-payment-btn"),y=document.getElementById("progress-bar"),I=document.getElementById("checkout-title"),l=document.getElementById("submit-order-btn"),E=document.getElementById("payment-phone"),z=document.getElementById("operator-logo-container"),k=document.getElementById("selected-payment-method"),B=document.getElementById("payment-instructions"),p=document.getElementById("use-geolocation-btn"),q=document.getElementById("address");if(!f||!l||!t){console.error("[Checkout] Éléments DOM critiques manquants (boutons ou erreur).");return}const T=async(s,i,r=null)=>{const n=(s||"").toUpperCase(),o=l.querySelector(".btn-spinner"),a=l.querySelector(".btn-text");if(n==="SUCCESS"||n==="SUCCEEDED"||n==="COMPLETED"){o&&o.classList.add("hidden"),a&&(a.textContent="Paiement réussi ! Redirection..."),y&&(y.style.width="100%"),setTimeout(()=>{J();try{K(`/order-success/?id=${encodeURIComponent(u||"")}`)}catch{window.location.href=`/order-success/?id=${encodeURIComponent(u||"")}`}},900);return}if(n==="PENDING"){o&&o.classList.add("hidden"),l.disabled=!1,a&&(a.textContent="Statut: En attente de confirmation"),y&&(y.style.width="95%"),t.textContent=i||"La transaction est en attente. Veuillez confirmer sur votre téléphone.",t.classList.remove("hidden");return}o&&o.classList.add("hidden"),l.disabled=!1,a&&(a.textContent="Confirmer et Payer"),t.textContent=i||"Le paiement a échoué. Veuillez réessayer ou contacter le support.",t.classList.remove("hidden")},O=async()=>{t.classList.add("hidden");const s=e.elements,i=s.name.value.trim(),r=s.email.value.trim(),n=s.phone.value.trim(),o=s.address.value.trim();if(!i||!r||!n||!o){t.textContent="Veuillez remplir tous les champs requis.",t.classList.remove("hidden");return}f.disabled=!0,f.textContent="Enregistrement...";try{const a={name:i,email:r,phone:n,address:o,notes:s.notes?.value.trim()||""},h=g.reduce((v,m)=>v+m.price.amount*m.quantity,0),w={customer:a,items:g,total:h,currency:g[0]?.price.currency||"EUR"},c=await F(w,x);if(!c.success||!c.orderId)throw new Error(c.error||"La création de la pré-commande a échoué.");u=c.orderId,c.readableId&&localStorage.setItem(`zflex_readable_${u}`,c.readableId),c.prospectId&&localStorage.setItem("zflex_prospectId",c.prospectId),C&&C.classList.add("hidden"),L&&L.classList.remove("hidden"),y&&(y.style.width="60%"),I&&(I.textContent="Étape 2: Paiement")}catch(a){t.textContent=a.message||"Une erreur est survenue.",t.classList.remove("hidden"),f.disabled=!1,f.textContent="Continuer vers le paiement"}},A=async s=>{if(s.preventDefault(),t.classList.add("hidden"),!u){t.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",t.classList.remove("hidden");return}const i=k?.value,n=(E?.value||"").replace(/\D/g,"");if(!i||!n||n.length<9){t.textContent="Veuillez entrer un numéro de paiement valide pour détecter l'opérateur.",t.classList.remove("hidden");return}l.disabled=!0;const o=l.querySelector(".btn-text"),a=l.querySelector(".btn-spinner");o&&(o.textContent="Initiation du paiement..."),a&&a.classList.remove("hidden");const h=`zflex_txref_${u}`;let w=localStorage.getItem(h);if(!w){w=W(u);try{localStorage.setItem(h,w)}catch{}}try{const c=V().storeId;if(!c)throw new Error("Erreur de configuration : ID du store manquant.");const v=await G(u,c,i,`+243${n}`,w),m=Y(v),P=X(v);if(m)if(String(m).toLowerCase().includes("transactionreference already exists")||String(m).toLowerCase().includes("transactionreference")&&String(m).toLowerCase().includes("exists"))try{const S=await U(u,c),d=S,$=d.transactionStatus||d.result?.transactionStatus||d.status||d.data?.transactionStatus||d.statusText||(d.success?d.result?.transactionStatus:void 0),M=d.message||d.result?.message||d.error||"La transaction existe déjà. Nous vérifions son statut.";await T($,M,S);return}catch{t.textContent="Impossible de vérifier le statut de la transaction existante.",t.classList.remove("hidden"),a&&a.classList.add("hidden"),l.disabled=!1,o&&(o.textContent="Confirmer et Payer");return}else throw new Error(String(m));if(P)if(P.toUpperCase()==="PENDING"){await T("PENDING","Veuillez confirmer sur votre téléphone...");return}else if(["SUCCESS","SUCCEEDED","COMPLETED"].includes(P.toUpperCase())){await T("SUCCESS","Paiement confirmé.");return}else throw new Error(`Statut de transaction inattendu: ${P}`);try{const S=await U(u,c),d=S,$=d.transactionStatus||d.result?.transactionStatus||d.status||d.data?.transactionStatus,M=d.message||d.result?.message||"";await T($,M,S)}catch{throw new Error("Statut de transaction inattendu.")}}catch(c){const v=c?.message||String(c);let m="Le lancement du paiement a échoué.";v.includes("transactionReference already exists")?m="Une tentative existe déjà. Vérification...":v.includes("transactionReference")?m="Erreur de référence. Rafraîchissez la page.":v.includes("aucun opérateur")||v.toLowerCase().includes("operator")?m="Opérateur non supporté pour ce numéro.":m=v,t.textContent=m,t.classList.remove("hidden"),a&&a.classList.add("hidden"),l.disabled=!1,o&&(o.textContent="Confirmer et Payer")}},H=()=>{const i=(E.value||"").replace(/\D/g,"").substring(0,2),r=["81","82","83"],n=["80","84","85","89"],o=["97","99"],a=["90"];let h="";r.includes(i)&&(h="MPESA"),n.includes(i)&&(h="ORANGE"),o.includes(i)&&(h="AIRTEL"),a.includes(i)&&(h="AFRICELL"),z&&(z.innerHTML=""),h&&k&&B?(k.value=h,B.innerHTML=`<p>Opérateur <strong>${h}</strong> détecté. Vous recevrez une notification pour valider.</p>`):k&&B&&(k.value="",B.innerHTML="<p>Veuillez entrer un numéro valide pour détecter l'opérateur.</p>")},N=()=>{if(!navigator.geolocation){t.textContent="La géolocalisation n'est pas supportée.",t.classList.remove("hidden");return}p.disabled=!0,p.classList.add("animate-pulse"),navigator.geolocation.getCurrentPosition(async s=>{const{latitude:i,longitude:r}=s.coords;try{const o=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${i}&lon=${r}`)).json();if(o&&o.display_name&&q)q.value=o.display_name;else throw new Error("Adresse non trouvée.")}catch{t.textContent="Impossible de récupérer l'adresse.",t.classList.remove("hidden")}finally{p.disabled=!1,p.classList.remove("animate-pulse")}},s=>{t.textContent="Erreur de géolocalisation ("+s.code+")",t.classList.remove("hidden"),p.disabled=!1,p.classList.remove("animate-pulse")},{timeout:1e4,enableHighAccuracy:!0})};return f.dataset.checkoutBound||(f.addEventListener("click",O),f.dataset.checkoutBound="true"),E&&!E.dataset.checkoutBound&&(E.addEventListener("input",H),E.dataset.checkoutBound="true"),p&&!p.dataset.checkoutBound&&(p.addEventListener("click",N),p.dataset.checkoutBound="true"),e.dataset.checkoutBound||(e.addEventListener("submit",A),e.dataset.checkoutBound="true"),console.log("[Checkout] Module V13.1 initialisé."),{destroy:()=>{console.log("[Checkout] Cleanup: Suppression des écouteurs..."),f.removeEventListener("click",O),delete f.dataset.checkoutBound,E&&(E.removeEventListener("input",H),delete E.dataset.checkoutBound),p&&(p.removeEventListener("click",N),delete p.dataset.checkoutBound),e.removeEventListener("submit",A),delete e.dataset.checkoutBound,console.log("[Checkout] Module détruit.")}}}export{te as initCheckout};
