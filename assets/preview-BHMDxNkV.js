function I(){console.log("[Preview] Initialisation du mode Ã©diteur temps rÃ©el (FOCUS SAFE MODE)"),L(),k();const g={"palette.primary":"--primary-color","palette.secondary":"--secondary-color","palette.background":"--bg-color","palette.text":"--text-color","palette.accent":"--accent-color","palette.cardBackground":"--card-bg-color","palette.textMuted":"--text-muted-color","palette.cardBorder":"--card-border-color","palette.inputBackground":"--input-bg-color","palette.chatResponseBackground":"--chat-response-bg-color",primary:"--primary-color",secondary:"--secondary-color",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardBackground:"--card-bg-color","primary-color":"--primary-color","bg-color":"--bg-color","card-bg-color":"--card-bg-color"};function u(t){if(!t)return null;if(typeof t=="string"&&t.startsWith("--"))return t;const e=String(t).trim();if(g[e])return g[e];if(e==="layout.borderRadius")return"--border-radius";if(e==="typography.headingFont")return"--heading-font";if(e==="typography.bodyFont")return"--body-font";if(e==="header.style")return null;if(e.includes("borderRadius"))return"--border-radius";if(e.includes("headingFont"))return"--heading-font";if(e.includes("bodyFont"))return"--body-font";const a=e.replace(/^palette[\._-]?/i,"").replace(/\./g,"").replace(/_/g,"").toLowerCase(),r={primary:"--primary-color",primary600:"--primary-600",primary700:"--primary-700",secondary:"--secondary-color",secondary600:"--secondary-600",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardbackground:"--card-bg-color",textmuted:"--text-muted-color",cardborder:"--card-border-color",inputbackground:"--input-bg-color",chatresponsebackground:"--chat-response-bg-color",borderradius:"--border-radius",headingfont:"--heading-font",bodyfont:"--body-font"};return r[a]?r[a]:`--${e.replace(/^palette[\._-]?/i,"").replace(/\./g,"-").replace(/_/g,"-").toLowerCase()}`}function h(t={}){if(!t||typeof t!="object")return;const e=document.documentElement;Object.keys(t).forEach(a=>{const r=t[a];if(typeof r!="string"&&typeof r!="number")return;const n=a.startsWith("--")?a:u(a)||`--${a}`;e.style.setProperty(n,String(r))}),window.requestAnimationFrame(()=>{document.body.offsetHeight})}function w(t){const{sections:e}=t,a=document.querySelector('main[data-page-type="home"]');if(!a)return;console.log("[Preview] Reordering layout...",e),console.log("[Preview] Layout update...",e);const r=Array.from(a.children).filter(s=>s.hasAttribute("data-zflex-section")),n=e.map(s=>s.type);let o=!1;if(r.forEach(s=>{const i=s.getAttribute("data-zflex-section");i&&!n.includes(i)&&(console.log(`[Preview] Removing section ${i}`),s.remove())}),e.forEach(s=>{const i=a.querySelector(`[data-zflex-section="${s.type}"]`);i?(a.appendChild(i),i.style.animation="none",i.offsetHeight,i.style.animation="fadeIn 0.5s"):(console.log(`[Preview] New section ${s.type} detected -> Reload required.`),o=!0)}),o){console.log("[Preview] Layout structure changed (Add/Remove), reloading page...");const s=document.createElement("div");s.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:9999;display:flex;justify-content:center;align-items:center;font-family:sans-serif;",s.innerHTML="<div style='background:white;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);'>Mise Ã  jour de la structure...</div>",document.body.appendChild(s),window.location.reload()}}function v(t){if(!t)return;const e=t.computed||{},a=t.palette||{},r={};Object.keys(a).forEach(n=>{const o=u(n)||u(`palette.${n}`)||`--${n}`;o&&(r[o]=a[n])}),Object.keys(e).forEach(n=>{const o=u(n)||`--${n.replace(/[A-Z]/g,s=>"-"+s.toLowerCase())}`;o&&(r[o]=e[n])}),h(r),console.log("[Preview] Applied computed palette vars:",r)}function $(t){if(t==null)return"";let e=String(t).trim();return/^[0-9A-Fa-f]{6}$/.test(e)&&(e="#"+e),e}function x(t){if(!t)return;let{property:e,value:a}=t;const r=u(e)||e,n=$(a);r&&(document.documentElement.style.setProperty(r,n),(r.includes("color")||r.includes("bg")||r.includes("background"))&&(document.body.style.transition="background-color 0.22s ease, color 0.22s ease, border-color 0.22s ease",setTimeout(()=>{document.body.style.transition=""},300)),console.log(`[Preview] Mise Ã  jour style (incoming: ${String(e)}) -> canonical: ${r}: ${n}`))}function A(t){if(!t)return;const{id:e,value:a}=t,r=document.querySelector(`[data-zflex-id="${e}"]`);if(!r){console.warn(`[Preview] Ã‰lÃ©ment introuvable : ${e}`);return}const n=r.tagName.toUpperCase();if(n==="IMG")r.src=a,r.alt||(r.alt="Image");else if(n==="I"||r.classList.contains("fa")||r.classList.contains("fas")||r.classList.contains("fab")||e.includes(".icon")){let o=String(a).trim();if(!o)return;!o.startsWith("fa-")&&!o.includes(" ")&&(o=`fa-${o}`),!o.includes("fas")&&!o.includes("fab")&&!o.includes("far")&&!o.includes("fal")&&(o=`fas ${o}`);const s=Array.from(r.classList).filter(i=>!i.startsWith("fa-")&&i!=="fas"&&i!=="fab"&&i!=="far"&&i!=="fa");r.className=`${s.join(" ")} ${o}`}else if(e.toLowerCase().includes("image")||e.includes("bg"))if(r.style.backgroundImage.includes("linear-gradient")){const o=r.style.backgroundImage.split(", url");r.style.backgroundImage=`${o[0]}, url('${a}')`}else r.style.backgroundImage=`url('${a}')`;else{const o=document.querySelectorAll(`[data-zflex-show="${e}"]`);if(o.length>0){const s=String(a)==="true"||a===!0;o.forEach(i=>{i.style.display=s?"":"none"}),s&&f(o[0]);return}/<[a-z][\s\S]*>/i.test(String(a))?r.innerHTML=String(a):r.textContent=String(a)}n!=="I"&&f(r)}function f(t){t&&(t.style.transition="transform 0.2s ease, outline 0.2s ease",t.style.outline="2px solid rgba(0, 229, 255, 0.5)",t.style.transform="scale(1.02)",t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{t.style.transform="",t.style.outline=""},400))}function S(t){const{id:e}=t;let a=document.querySelector(`[data-zflex-section="${e.toLowerCase()}"]`)||document.querySelector(`[data-zflex-id="${e}"]`)||document.getElementById(e);a?f(a):console.log(`[Preview] Highlight: Element ${e} not found.`)}window.addEventListener("message",t=>{if(!t?.data)return;const e=t.data;if(e.source==="zflex-admin")switch(console.log("[Preview] Message reÃ§u de l'Ã©diteur:",e),e.action){case"updateElement":A(e.payload);break;case"updateStyle":x(e.payload);break;case"updatePalette":v(e.payload);break;case"updateRepeater":z(e.payload);break;case"updateVariant":P(e.payload);break;case"updateLayout":w(e.payload);break;case"highlight":S(e.payload);break;default:console.warn("[Preview] Action non reconnue:",e.action)}});function P(t){const{id:e,variant:a,data:r}=t,n=document.querySelector(`[data-zflex-variant-container="${e}"]`),o=document.querySelector(`template[data-zflex-variant="${e}.${a}"]`);if(!n||!o){console.warn(`[Preview] Impossible de changer le variant : ${e} -> ${a} (Template/Container missing)`);return}console.log(`[Preview] Swap variant ${e} vers ${a}`);const i=o.content.cloneNode(!0).firstElementChild;i&&(m(i,r,e),i.querySelectorAll("[data-zflex-repeater]").forEach(c=>{const l=c.getAttribute("data-zflex-repeater");if(!l)return;const d=l.split("."),C=d[d.length-1],b=r[C];Array.isArray(b)&&y(c,l,b)}),n.style.opacity="0",setTimeout(()=>{n.innerHTML="",n.appendChild(i),n.style.opacity="1"},150))}function y(t,e,a){const r=document.querySelector(`template[data-zflex-template="${e}"]`);r&&(t.innerHTML="",a.forEach((n,o)=>{const i=r.content.cloneNode(!0).firstElementChild;i&&(E(i,e,o),m(i,n,`${e}[${o}]`),t.appendChild(i))}))}function E(t,e,a){if(t.querySelectorAll("[data-zflex-bind]").forEach(n=>{const o=n.getAttribute("data-zflex-bind");n.setAttribute("data-zflex-id",`${e}[${a}].${o}`)}),t.hasAttribute("data-zflex-bind")){const n=t.getAttribute("data-zflex-bind");t.setAttribute("data-zflex-id",`${e}[${a}].${n}`)}}function m(t,e,a=""){const r=t.querySelectorAll("[data-zflex-bind]"),n=(o,s,i)=>{if(i==null)return;const p=o.tagName.toUpperCase();if(p==="IMG")o.src=String(i);else if(s==="icon"||o.tagName==="I"||o.classList.contains("fa")){let c=String(i).trim();if(c){!c.startsWith("fa-")&&!c.includes(" ")&&(c=`fa-${c}`),!c.includes("fas")&&!c.includes("fab")&&(c=`fas ${c}`);const l=Array.from(o.classList).filter(d=>!d.startsWith("fa")&&d!=="fas"&&d!=="fab");o.className=`${l.join(" ")} ${c}`}}else if(s.includes("image")||s.includes("bg")||s.includes("cover")){if(p!=="IMG"){const c=o.style.backgroundImage||window.getComputedStyle(o).backgroundImage;if(c&&c.includes("gradient")){const l=c.replace(/url\(['"]?.*?['"]?\)/,`url('${i}')`);o.style.backgroundImage=l}else o.style.backgroundImage=`url('${i}')`}}else s==="image_position"?i==="left"?(o.classList.remove("image-right"),o.classList.add("image-left")):(o.classList.remove("image-left"),o.classList.add("image-right")):s==="style"&&o.classList.contains("reveal-section")?o.className=o.className.replace(/style-\w+/,`style-${i}`):o.textContent=String(i)};if(r.forEach(o=>{const s=o.getAttribute("data-zflex-bind");s&&n(o,s,e[s])}),t.hasAttribute("data-zflex-bind")){const o=t.getAttribute("data-zflex-bind");o&&n(t,o,e[o])}if(a.includes("reveal")&&e.image_position){const o=t.querySelector(".reveal-grid");o&&n(o,"image_position",e.image_position)}}function z(t){const{id:e,items:a}=t,r=document.querySelector(`[data-zflex-repeater="${e}"]`);r?(console.log(`[Preview] RÃ©gÃ©nÃ©ration du repeater ${e}`),y(r,e,a),r.style.transition="opacity 0.2s",r.style.opacity="0.5",setTimeout(()=>r.style.opacity="1",200)):console.warn(`[Preview] Repeater container not found: ${e}`)}function L(){console.log("[Preview] Activating Interaction Hijacking (Anti-Navigation)"),document.addEventListener("click",t=>{const e=t.target.closest("a, button, input[type='submit']");if(!e)return;if(e.classList.contains("btn-primary")||e.id.includes("add-to-cart")||e.textContent?.toLowerCase().includes("commander")||e.closest("#cart-btn")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Action commerciale bloquÃ©e:",e);return}if(e.tagName==="A"){const r=e.getAttribute("href");if(r&&r!=="#"&&!r.startsWith("javascript:")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Navigation bloquÃ©e:",r);return}}console.log("âœ… [Preview] Interaction autorisÃ©e:",e)},!0),document.addEventListener("submit",t=>{t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Soumission de formulaire bloquÃ©e.")},!0)}function k(){window.__ZFLEX_PREVIEW_MODE__=!0,console.log("ðŸš« [Preview] Analytics neutralized via Global Flag.")}window.parent!==window&&window.parent.postMessage({source:"zflex-preview",action:"ready",payload:{url:window.location.href}},"*")}export{I as initPreviewMode};
