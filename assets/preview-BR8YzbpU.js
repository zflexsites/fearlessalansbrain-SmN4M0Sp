function q(){console.log("[Preview] Initialisation du mode Ã©diteur temps rÃ©el (FOCUS V2 - LIVE ARCHITECTURE)"),L(),k();const y={"palette.primary":"--primary-color","palette.secondary":"--secondary-color","palette.background":"--bg-color","palette.text":"--text-color","palette.accent":"--accent-color","palette.cardBackground":"--card-bg-color","palette.textMuted":"--text-muted-color","palette.cardBorder":"--card-border-color","palette.inputBackground":"--input-bg-color","palette.chatResponseBackground":"--chat-response-bg-color",primary:"--primary-color",secondary:"--secondary-color",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardBackground:"--card-bg-color","primary-color":"--primary-color","bg-color":"--bg-color","card-bg-color":"--card-bg-color"};function f(t){if(!t)return null;if(typeof t=="string"&&t.startsWith("--"))return t;const e=String(t).trim(),r={"layout.borderRadius":"--border-radius","typography.headingFont":"--heading-font","typography.bodyFont":"--body-font","header.style":""};if(r[e])return r[e]||null;if(y[e])return y[e];const i=e.replace(/^(palette|layout|typography)[\._-]?/i,"").replace(/\./g,"").replace(/_/g,"").toLowerCase(),o={primary:"--primary-color",primary600:"--primary-600",primary700:"--primary-700",secondary:"--secondary-color",secondary600:"--secondary-600",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardbackground:"--card-bg-color",textmuted:"--text-muted-color",cardborder:"--card-border-color",inputbackground:"--input-bg-color",chatresponsebackground:"--chat-response-bg-color",borderradius:"--border-radius",headingfont:"--heading-font",bodyfont:"--body-font"};return o[i]?o[i]:`--${e.replace(/^palette[\._-]?/i,"").replace(/\./g,"-").replace(/_/g,(a,s)=>s>0?"-":"").replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`}function w(t={}){if(!t||typeof t!="object")return;const e=document.documentElement;Object.keys(t).forEach(r=>{const i=t[r];if(typeof i!="string"&&typeof i!="number")return;const o=r.startsWith("--")?r:f(r)||`--${r}`;e.style.setProperty(o,String(i))}),window.requestAnimationFrame(()=>{document.body.offsetHeight})}function $(t){const{sections:e}=t,r=document.querySelector('main[data-zflex-page-type="home"]');if(!r)return;console.log("[Preview] Syncing layout...",e);const i=Array.from(r.children).filter(a=>a.hasAttribute("data-zflex-section")),o=e.map(a=>a.type);let n=[];if(i.forEach(a=>{const s=a.getAttribute("data-zflex-section");s&&!o.includes(s)&&(console.log(`[Preview] Removing section ${s}`),a.remove())}),e.forEach(a=>{const s=r.querySelector(`[data-zflex-section="${a.type}"]`);s?r.appendChild(s):(console.log(`[Preview] Missing section ${a.type}`),n.push(a.type))}),n.length>0){console.warn(`[Preview] ${n.length} sections missing. Waiting for live injection or artifact refresh...`);const a=sessionStorage.getItem("__zflex_last_reload"),s=Date.now();if(a&&s-parseInt(a)<1e4){console.error("ðŸš« [Preview] RELOAD GUARD ACTIVE: Reload loop detected. Aborting reload.");return}setTimeout(()=>{n.some(c=>!r.querySelector(`[data-zflex-section="${c}"]`))&&(console.log("[Preview] Sections still missing after wait. Triggering safe reload."),sessionStorage.setItem("__zflex_last_reload",s.toString()),window.location.reload())},2e3)}}function v(t){const{type:e,html:r}=t,i=document.querySelector('main[data-zflex-page-type="home"]');if(!i)return;console.log(`[Preview] Injecting template for ${e}...`);const o=document.createElement("div");o.innerHTML=r.trim();const n=o.firstElementChild;if(n){n.setAttribute("data-zflex-section",e);const a=i.querySelector(`[data-zflex-section="${e}"]`);a?a.replaceWith(n):i.appendChild(n),console.log(`[Preview] Section ${e} injected successfully.`),n.style.animation="pulse-glow 1s ease-in-out"}}function S(t){if(!t)return;const e=t.computed||{},r=t.palette||{},i={};Object.keys(r).forEach(o=>{const n=f(o)||f(`palette.${o}`)||`--${o}`;n&&(i[n]=r[o])}),Object.keys(e).forEach(o=>{const n=f(o)||`--${o.replace(/[A-Z]/g,a=>"-"+a.toLowerCase())}`;n&&(i[n]=e[o])}),w(i),console.log("[Preview] Applied computed palette vars:",i)}function x(t){if(t==null)return"";let e=String(t).trim();return/^[0-9A-Fa-f]{6}$/.test(e)&&(e="#"+e),e}function A(t){if(!t)return;let{property:e,value:r}=t;const i=f(e)||e,o=x(r);i&&(document.documentElement.style.setProperty(i,o),(i.includes("color")||i.includes("bg")||i.includes("background"))&&(document.body.style.transition="background-color 0.22s ease, color 0.22s ease, border-color 0.22s ease",setTimeout(()=>{document.body.style.transition=""},300)),console.log(`[Preview] Mise Ã  jour style (incoming: ${String(e)}) -> canonical: ${i}: ${o}`))}function z(t){if(!t)return;const{id:e,value:r}=t,i=document.querySelectorAll(`[data-zflex-show="${e}"]`);if(i.length>0){const a=String(r)==="true";i.forEach(s=>{s.style.setProperty("display",a?"":"none","important")}),a&&m(i[0])}if(e==="howItWorks.showIcons")return;const o=document.querySelector(`[data-zflex-id="${e}"]`);if(!o){i.length===0&&console.warn(`[Preview] Ã‰lÃ©ment introuvable : ${e}`);return}const n=o.tagName.toUpperCase();if(n==="IMG")o.src=r,o.alt||(o.alt="Image");else if(n==="I"||o.classList.contains("fa")||o.classList.contains("fas")||o.classList.contains("fab")||o.classList.contains("far")||o.classList.contains("fal")||e.includes(".icon")){let a=String(r).trim();if(!a)return;!a.startsWith("fa-")&&!a.includes(" ")&&(a=`fa-${a}`),!a.includes("fas")&&!a.includes("fab")&&!a.includes("far")&&!a.includes("fal")&&(a=`fas ${a}`);const s=Array.from(o.classList).filter(l=>!l.startsWith("fa-")&&l!=="fas"&&l!=="fab"&&l!=="far"&&l!=="fa");if(e.includes("features.items")){const l=o.closest(".feature-visual-wrapper");if(l){const c=l.querySelector(".feature-img-bind"),d=l.querySelector(".feature-icon-bind");if(c&&d){const u=!!r&&r!==""&&r!=="null",p=c,g=p.src&&!p.src.includes("undefined")&&!p.src.endsWith("/");c.style.display=g?"":"none",d.style.display=u&&!g?"":"none"}}}o.className=`${s.join(" ")} ${a}`}else if(e.toLowerCase().includes("image")||e.includes("bg")||e.includes("cover")){const a=o.style.backgroundImage;if(a&&a.includes("gradient")){const s=a.replace(/url\(['"]?.*?['"]?\)/,`url('${r}')`);o.style.backgroundImage=s}else o.style.backgroundImage=`url('${r}')`;if(e.includes("features.items")){const s=o.closest(".feature-visual-wrapper");if(s){const l=s.querySelector(".feature-img-bind"),c=s.querySelector(".feature-icon-bind");if(l&&c){const d=!!r&&r!==""&&r!=="null";l.style.display=d?"":"none",c.style.display=d?"none":""}}}}else{const a=document.querySelectorAll(`[data-zflex-show="${e}"]`);if(a.length>0){const s=String(r)==="true";a.forEach(l=>{l.style.setProperty("display",s?"":"none","important")}),s&&m(a[0]);return}/<[a-z][\s\S]*>/i.test(String(r))?o.innerHTML=String(r):o.textContent=String(r)}n!=="I"&&m(o)}function m(t){t&&(t.style.transition="transform 0.2s ease, outline 0.2s ease",t.style.outline="2px solid rgba(0, 229, 255, 0.5)",t.style.transform="scale(1.02)",t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{t.style.transform="",t.style.outline=""},400))}function E(t){const{id:e}=t;let r=document.querySelector(`[data-zflex-section="${e.toLowerCase()}"]`)||document.querySelector(`[data-zflex-id="${e}"]`)||document.getElementById(e);r?m(r):console.log(`[Preview] Highlight: Element ${e} not found.`)}window.addEventListener("message",t=>{if(!t?.data)return;const e=t.data;if(e.source==="zflex-admin")switch(console.log("[Preview] Message reÃ§u de l'Ã©diteur:",e),e.action){case"updateElement":z(e.payload);break;case"updateStyle":A(e.payload);break;case"updatePalette":S(e.payload);break;case"updateRepeater":C(e.payload);break;case"updateVariant":P(e.payload);break;case"updateLayout":$(e.payload);break;case"highlight":E(e.payload);break;case"injectTemplate":v(e.payload);break;default:console.warn("[Preview] Action non reconnue:",e.action)}});function P(t){const{id:e,variant:r,data:i}=t,o=document.querySelector(`[data-zflex-variant-container="${e}"]`),n=document.querySelector(`template[data-zflex-variant="${e}.${r}"]`);if(!o||!n){console.warn(`[Preview] Impossible de changer le variant : ${e} -> ${r} (Template/Container missing)`);return}console.log(`[Preview] Swap variant ${e} vers ${r}`);const s=n.content.cloneNode(!0).firstElementChild;s&&(h(s,i,e),s.querySelectorAll("[data-zflex-repeater]").forEach(c=>{const d=c.getAttribute("data-zflex-repeater");if(!d)return;const u=d.split("."),p=u[u.length-1],g=i[p];Array.isArray(g)&&b(c,d,g)}),o.style.opacity="0",setTimeout(()=>{o.innerHTML="",o.appendChild(s),o.style.opacity="1"},150))}function b(t,e,r){const i=document.querySelector(`template[data-zflex-template="${e}"]`);i&&(t.innerHTML="",r.forEach((o,n)=>{const s=i.content.cloneNode(!0).firstElementChild;s&&(I(s,e,n),h(s,o,`${e}[${n}]`),t.appendChild(s))}))}function I(t,e,r){if(t.querySelectorAll("[data-zflex-bind]").forEach(o=>{const n=o.getAttribute("data-zflex-bind");o.setAttribute("data-zflex-id",`${e}[${r}].${n}`)}),t.hasAttribute("data-zflex-bind")){const o=t.getAttribute("data-zflex-bind");t.setAttribute("data-zflex-id",`${e}[${r}].${o}`)}}function h(t,e,r=""){const i=t.querySelectorAll("[data-zflex-bind]"),o=(n,a,s)=>{if(s==null)return;const l=n.tagName.toUpperCase();if(l==="IMG")n.src=String(s);else if(a==="icon"||n.tagName==="I"||n.classList.contains("fa")){let c=String(s).trim();if(c){!c.startsWith("fa-")&&!c.includes(" ")&&(c=`fa-${c}`),!c.includes("fas")&&!c.includes("fab")&&(c=`fas ${c}`);const d=Array.from(n.classList).filter(u=>!u.startsWith("fa")&&u!=="fas"&&u!=="fab");n.className=`${d.join(" ")} ${c}`}}else if(a.includes("image")||a.includes("bg")||a.includes("cover")){if(l!=="IMG"){const c=n.style.backgroundImage||window.getComputedStyle(n).backgroundImage;if(c&&c.includes("gradient")){const d=c.replace(/url\(['"]?.*?['"]?\)/,`url('${s}')`);n.style.backgroundImage=d}else n.style.backgroundImage=`url('${s}')`}}else a==="image_position"?s==="left"?(n.classList.remove("image-right"),n.classList.add("image-left")):(n.classList.remove("image-left"),n.classList.add("image-right")):a==="style"&&n.classList.contains("reveal-section")?n.className=n.className.replace(/style-\w+/,`style-${s}`):n.textContent=String(s)};if(i.forEach(n=>{const a=n.getAttribute("data-zflex-bind");a&&o(n,a,e[a])}),t.hasAttribute("data-zflex-bind")){const n=t.getAttribute("data-zflex-bind");n&&o(t,n,e[n])}if(r.includes("reveal")&&e.image_position){const n=t.querySelector(".reveal-grid");n&&o(n,"image_position",e.image_position)}}function C(t){const{id:e,items:r}=t,i=document.querySelector(`[data-zflex-repeater="${e}"]`);i?(console.log(`[Preview] RÃ©gÃ©nÃ©ration du repeater ${e}`),b(i,e,r),i.style.transition="opacity 0.2s",i.style.opacity="0.5",setTimeout(()=>i.style.opacity="1",200)):console.warn(`[Preview] Repeater container not found: ${e}`)}function L(){console.log("[Preview] Activating Interaction Hijacking (Anti-Navigation)"),document.addEventListener("click",t=>{const e=t.target.closest("a, button, input[type='submit']");if(!e)return;if(e.classList.contains("btn-primary")||e.id.includes("add-to-cart")||e.textContent?.toLowerCase().includes("commander")||e.closest("#cart-btn")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Action commerciale bloquÃ©e:",e);return}if(e.tagName==="A"){const i=e.getAttribute("href");if(i&&i!=="#"&&!i.startsWith("javascript:")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Navigation bloquÃ©e:",i);return}}console.log("âœ… [Preview] Interaction autorisÃ©e:",e)},!0),document.addEventListener("submit",t=>{t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Soumission de formulaire bloquÃ©e.")},!0)}function k(){window.__ZFLEX_PREVIEW_MODE__=!0,console.log("ðŸš« [Preview] Analytics neutralized via Global Flag.")}window.parent!==window&&window.parent.postMessage({source:"zflex-preview",action:"ready",payload:{url:window.location.href}},"*")}export{q as initPreviewMode};
