function E(){console.log("[Preview] Initialisation du mode Ã©diteur temps rÃ©el (FOCUS SAFE MODE)"),A(),C();const f={"palette.primary":"--primary-color","palette.secondary":"--secondary-color","palette.background":"--bg-color","palette.text":"--text-color","palette.accent":"--accent-color","palette.cardBackground":"--card-bg-color","palette.textMuted":"--text-muted-color","palette.cardBorder":"--card-border-color","palette.inputBackground":"--input-bg-color","palette.chatResponseBackground":"--chat-response-bg-color",primary:"--primary-color",secondary:"--secondary-color",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardBackground:"--card-bg-color","primary-color":"--primary-color","bg-color":"--bg-color","card-bg-color":"--card-bg-color"};function u(t){if(!t)return null;if(typeof t=="string"&&t.startsWith("--"))return t;const e=String(t).trim();if(f[e])return f[e];const n=e.replace(/^palette[\._-]?/i,"").replace(/\./g,"").replace(/_/g,"").toLowerCase(),o={primary:"--primary-color",primary600:"--primary-600",primary700:"--primary-700",secondary:"--secondary-color",secondary600:"--secondary-600",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardbackground:"--card-bg-color",textmuted:"--text-muted-color",cardborder:"--card-border-color",inputbackground:"--input-bg-color",chatresponsebackground:"--chat-response-bg-color"};return o[n]?o[n]:`--${e.replace(/^palette[\._-]?/i,"").replace(/\./g,"-").replace(/_/g,"-").toLowerCase()}`}function m(t={}){if(!t||typeof t!="object")return;const e=document.documentElement;Object.keys(t).forEach(n=>{const o=t[n];if(typeof o!="string"&&typeof o!="number")return;const a=n.startsWith("--")?n:u(n)||`--${n}`;e.style.setProperty(a,String(o))}),window.requestAnimationFrame(()=>{document.body.offsetHeight})}function y(t){if(!t)return;const e=t.computed||{},n=t.palette||{},o={};Object.keys(n).forEach(a=>{const r=u(a)||u(`palette.${a}`)||`--${a}`;r&&(o[r]=n[a])}),Object.keys(e).forEach(a=>{const r=u(a)||`--${a.replace(/[A-Z]/g,i=>"-"+i.toLowerCase())}`;r&&(o[r]=e[a])}),m(o),console.log("[Preview] Applied computed palette vars:",o)}function b(t){if(t==null)return"";let e=String(t).trim();return/^[0-9A-Fa-f]{6}$/.test(e)&&(e="#"+e),e}function h(t){if(!t)return;let{property:e,value:n}=t;const o=u(e)||e,a=b(n);o&&(document.documentElement.style.setProperty(o,a),(o.includes("color")||o.includes("bg")||o.includes("background"))&&(document.body.style.transition="background-color 0.22s ease, color 0.22s ease, border-color 0.22s ease",setTimeout(()=>{document.body.style.transition=""},300)),console.log(`[Preview] Mise Ã  jour style (incoming: ${String(e)}) -> canonical: ${o}: ${a}`))}function w(t){if(!t)return;const{id:e,value:n}=t,o=document.querySelector(`[data-zflex-id="${e}"]`);if(!o){console.warn(`[Preview] Ã‰lÃ©ment introuvable : ${e}`);return}const a=o.tagName.toUpperCase();if(a==="IMG")o.src=n,o.alt||(o.alt="Image");else if(a==="I"||o.classList.contains("fa")||o.classList.contains("fas")||o.classList.contains("fab")||e.includes(".icon")){let r=String(n).trim();if(!r)return;!r.startsWith("fa-")&&!r.includes(" ")&&(r=`fa-${r}`),!r.includes("fas")&&!r.includes("fab")&&!r.includes("far")&&!r.includes("fal")&&(r=`fas ${r}`);const i=Array.from(o.classList).filter(c=>!c.startsWith("fa-")&&c!=="fas"&&c!=="fab"&&c!=="far"&&c!=="fa");o.className=`${i.join(" ")} ${r}`}else if(e.toLowerCase().includes("image")||e.includes("bg"))if(o.style.backgroundImage.includes("linear-gradient")){const r=o.style.backgroundImage.split(", url");o.style.backgroundImage=`${r[0]}, url('${n}')`}else o.style.backgroundImage=`url('${n}')`;else/<[a-z][\s\S]*>/i.test(n)?o.innerHTML=n:o.textContent=n;a!=="I"&&p(o)}function p(t){t&&(t.style.transition="transform 0.2s ease, outline 0.2s ease",t.style.outline="2px solid rgba(0, 229, 255, 0.5)",t.style.transform="scale(1.02)",t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{t.style.transform="",t.style.outline=""},400))}function $(t){const{id:e}=t;let n=document.querySelector(`[data-zflex-section="${e.toLowerCase()}"]`)||document.querySelector(`[data-zflex-id="${e}"]`)||document.getElementById(e);n?p(n):console.log(`[Preview] Highlight: Element ${e} not found.`)}window.addEventListener("message",t=>{if(!t?.data)return;const e=t.data;if(e.source==="zflex-admin")switch(console.log("[Preview] Message reÃ§u de l'Ã©diteur:",e),e.action){case"updateElement":w(e.payload);break;case"updateStyle":h(e.payload);break;case"updatePalette":y(e.payload);break;case"updateRepeater":S(e.payload);break;case"updateVariant":x(e.payload);break;case"updateLayout":v(e.payload);break;case"highlight":$(e.payload);break;default:console.warn("[Preview] Action non reconnue:",e.action)}});function v(t){const{sections:e}=t,n=document.querySelector('main[data-page-type="home"]');n&&(console.log("[Preview] Reordering layout...",e),e.forEach(o=>{const a=n.querySelector(`[data-zflex-section="${o.type}"]`);a&&(n.appendChild(a),a.style.animation="none",a.offsetHeight,a.style.animation="fadeIn 0.5s")}))}function x(t){const{id:e,variant:n,data:o}=t,a=document.querySelector(`[data-zflex-variant-container="${e}"]`),r=document.querySelector(`template[data-zflex-variant="${e}.${n}"]`);if(!a||!r){console.warn(`[Preview] Impossible de changer le variant : ${e} -> ${n}`);return}console.log(`[Preview] Swap variant ${e} vers ${n}`);const c=r.content.cloneNode(!0).firstElementChild;c&&(g(c,o),a.style.opacity="0",setTimeout(()=>{a.innerHTML="",a.appendChild(c),a.style.opacity="1"},150))}function g(t,e){const n=t.querySelectorAll("[data-zflex-bind]"),o=(a,r,i)=>{const c=a.tagName.toUpperCase();if(c==="IMG")a.src=String(i);else if(c==="A"&&(r.toLowerCase().includes("link")||r.toLowerCase().includes("url")))a.href=String(i);else if(c==="I"||a.classList.contains("fa")||r==="icon"||r.includes(".icon")){const d=Array.from(a.classList).filter(l=>!l.startsWith("fa-")&&l!=="fas"&&l!=="fab"&&l!=="far"&&l!=="fa");let s=String(i).trim();if(!s)return;!s.startsWith("fa-")&&!s.includes(" ")&&(s=`fa-${s}`),!s.includes("fas")&&!s.includes("fab")&&!s.includes("far")&&(s=`fas ${s}`),a.className=`${d.join(" ")} ${s}`}else r.toLowerCase().includes("image")||r.includes("bg")?a.style.backgroundImage=`url('${i}')`:typeof i=="string"&&/<[a-z][\s\S]*>/i.test(i)?a.innerHTML=i:a.textContent=String(i)};if(n.forEach(a=>{const r=a.getAttribute("data-zflex-bind");if(!r)return;const i=e[r];i!==void 0&&o(a,r,i)}),t.hasAttribute("data-zflex-bind")){const a=t.getAttribute("data-zflex-bind");a&&e[a]!==void 0&&o(t,a,e[a])}}function S(t){const{id:e,items:n}=t,o=document.querySelector(`[data-zflex-repeater="${e}"]`),a=document.querySelector(`template[data-zflex-template="${e}"]`);if(!o||!a){console.warn(`[Preview] Repeater update failed for ${e}`);return}console.log(`[Preview] Regenerating repeater ${e} (${n.length} items)`),o.innerHTML="",n.forEach((r,i)=>{const d=a.content.cloneNode(!0).firstElementChild;if(d){if(d.querySelectorAll("[data-zflex-bind]").forEach(l=>{const P=l.getAttribute("data-zflex-bind");l.setAttribute("data-zflex-id",`${e}[${i}].${P}`)}),d.hasAttribute("data-zflex-bind")){const l=d.getAttribute("data-zflex-bind");d.setAttribute("data-zflex-id",`${e}[${i}].${l}`)}g(d,r),o.appendChild(d)}}),o.style.opacity="0.5",setTimeout(()=>o.style.opacity="1",150)}function A(){console.log("[Preview] Activating Interaction Hijacking (Anti-Navigation)"),document.addEventListener("click",t=>{const e=t.target.closest("a, button, input[type='submit']");if(!e)return;if(e.classList.contains("btn-primary")||e.id.includes("add-to-cart")||e.textContent?.toLowerCase().includes("commander")||e.closest("#cart-btn")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Action commerciale bloquÃ©e:",e);return}if(e.tagName==="A"){const o=e.getAttribute("href");if(o&&o!=="#"&&!o.startsWith("javascript:")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Navigation bloquÃ©e:",o);return}}console.log("âœ… [Preview] Interaction autorisÃ©e:",e)},!0),document.addEventListener("submit",t=>{t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Soumission de formulaire bloquÃ©e.")},!0)}function C(){window.__ZFLEX_PREVIEW_MODE__=!0,console.log("ðŸš« [Preview] Analytics neutralized via Global Flag.")}window.parent!==window&&window.parent.postMessage({source:"zflex-preview",action:"ready",payload:{url:window.location.href}},"*")}export{E as initPreviewMode};
