function _(){console.log("[Preview] Initialisation du mode Ã©diteur temps rÃ©el (FOCUS V2 - LIVE ARCHITECTURE)");const m=new Map;function h(t,e){m.set(t,e),console.log(`[Preview] Update buffÃ©risÃ©e pour ${t} (Ã©lÃ©ment manquant)`)}function w(){if(m.size===0)return;console.log(`[Preview] Tentative de rejouer le buffer (${m.size} messages)...`);const t=Array.from(m.values());m.clear(),t.forEach(e=>{x({data:e})})}W(),j();const v={"palette.primary":"--primary-color","palette.secondary":"--secondary-color","palette.background":"--bg-color","palette.text":"--text-color","palette.accent":"--accent-color","palette.cardBackground":"--card-bg-color","palette.textMuted":"--text-muted-color","palette.cardBorder":"--card-border-color","palette.inputBackground":"--input-bg-color","palette.chatResponseBackground":"--chat-response-bg-color",primary:"--primary-color",secondary:"--secondary-color",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardBackground:"--card-bg-color","primary-color":"--primary-color","bg-color":"--bg-color","card-bg-color":"--card-bg-color"};function g(t){if(!t)return null;if(typeof t=="string"&&t.startsWith("--"))return t;const e=String(t).trim(),o={"layout.borderRadius":"--border-radius","typography.headingFont":"--heading-font","typography.bodyFont":"--body-font","header.style":""};if(o[e])return o[e]||null;if(v[e])return v[e];const n=e.replace(/^(palette|layout|typography)[\._-]?/i,"").replace(/\./g,"").replace(/_/g,"").toLowerCase(),i={primary:"--primary-color",primary600:"--primary-600",primary700:"--primary-700",secondary:"--secondary-color",secondary600:"--secondary-600",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardbackground:"--card-bg-color",textmuted:"--text-muted-color",cardborder:"--card-border-color",inputbackground:"--input-bg-color",chatresponsebackground:"--chat-response-bg-color",borderradius:"--border-radius",headingfont:"--heading-font",bodyfont:"--body-font"};return i[n]?i[n]:`--${e.replace(/^(palette|layout|typography)[\._-]?/i,"").replace(/\./g,"-").replace(/_/g,(r,l)=>l>0?"-":"").replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`}function P(t={}){if(!t||typeof t!="object")return;const e=document.documentElement;Object.keys(t).forEach(o=>{const n=t[o];if(typeof n!="string"&&typeof n!="number")return;const i=o.startsWith("--")?o:g(o)||`--${o}`;e.style.setProperty(i,String(n))}),window.requestAnimationFrame(()=>{document.body.offsetHeight})}function E(t){const{sections:e}=t,o=document.querySelector('main[data-zflex-page-type="home"]');if(!o)return;console.log("[Preview] Syncing layout...",e);const n=Array.from(o.children).filter(r=>r.hasAttribute("data-zflex-section")),i=e.map(r=>r.type);let a=[];n.forEach(r=>{const l=r.getAttribute("data-zflex-section");l&&!i.includes(l)&&(console.log(`[Preview] Removing section ${l}`),r.remove())}),e.forEach(r=>{const l=r.type,s=l.replace(/[A-Z]/g,d=>`_${d.toLowerCase()}`),c=o.querySelector(`[data-zflex-section="${l}"]`)||o.querySelector(`[data-zflex-section="${s}"]`);c?(o.appendChild(c),c.getAttribute("data-zflex-section")!==l&&c.setAttribute("data-zflex-section",l)):(console.log(`[Preview] Missing section ${l} (checked ${s} too)`),a.push(l))}),a.length>0&&(console.warn(`[Preview] ${a.length} sections manquant(s) dans le DOM :`,a),console.info("[Preview] L'injection de template devrait suivre. Pas de reload automatique (User choice)."))}function C(t){const{type:e,html:o}=t,n=document.querySelector('main[data-zflex-page-type="home"]');if(!n){console.error("[Preview] Injection annulÃ©e : Ã‰lÃ©ment <main> introuvable.");return}console.log(`[Preview] Injection du partiel pour : ${e}`);const i=document.createElement("div");i.innerHTML=o.trim();const a=Array.from(i.childNodes);let r=null;for(const l of a){if(l.nodeType!==Node.ELEMENT_NODE)continue;const s=l,c=s.tagName.toUpperCase();if(console.log(`[Preview] -> Processing tag: ${c}`,{id:s.getAttribute("data-zflex-id"),variant:s.getAttribute("data-zflex-variant"),template:s.getAttribute("data-zflex-template")}),c==="STYLE")document.head.appendChild(s);else if(c==="TEMPLATE"){const d=s.getAttribute("data-zflex-variant"),u=s.getAttribute("data-zflex-template"),f=d||u;if(f){const p=document.querySelector(`template[data-zflex-variant="${f}"], template[data-zflex-template="${f}"]`);p&&p.remove()}document.body.appendChild(s)}else if(c==="SCRIPT"){const d=document.createElement("script");Array.from(s.attributes).forEach(u=>d.setAttribute(u.name,u.value)),d.textContent=s.textContent,document.body.appendChild(d)}else{s.setAttribute("data-zflex-section",e);const d=n.querySelector(`[data-zflex-section="${e}"]`);d?(console.log(`[Preview] Replacing existing section: ${e}`),d.replaceWith(s)):(console.log(`[Preview] Appending new section: ${e}`),n.appendChild(s)),r=s}}r?(console.log(`[Preview] Section ${e} injectÃ©e avec succÃ¨s (+ styles/templates).`),r.style.animation="pulse-glow 1s ease-in-out",w()):(console.warn(`[Preview] Aucun contenu visuel injectÃ© pour ${e}. VÃ©rifiez le HTML.`),w())}function L(t){if(!t)return;const e=t.computed||{},o=t.palette||{},n={};Object.keys(o).forEach(i=>{const a=g(i)||g(`palette.${i}`)||`--${i}`;a&&(n[a]=o[i])}),Object.keys(e).forEach(i=>{const a=g(i)||`--${i.replace(/[A-Z]/g,r=>"-"+r.toLowerCase())}`;a&&(n[a]=e[i])}),P(n),console.log("[Preview] Applied computed palette vars:",n)}function I(t){if(t==null)return"";let e=String(t).trim();return/^[0-9A-Fa-f]{6}$/.test(e)&&(e="#"+e),e}function $(t){if(!t)return;let{property:e,value:o}=t;const n=g(e)||e,i=I(o);n&&(document.documentElement.style.setProperty(n,i),(n.includes("color")||n.includes("bg")||n.includes("background"))&&(document.body.style.transition="background-color 0.22s ease, color 0.22s ease, border-color 0.22s ease",setTimeout(()=>{document.body.style.transition=""},300)),console.log(`[Preview] Mise Ã  jour style (incoming: ${String(e)}) -> canonical: ${n}: ${i}`))}function q(t,e){if(!t)return;const{id:o,value:n}=t,i=g(o);if(i&&(i.startsWith("--")||o.startsWith("palette.")||o.startsWith("layout.")||o.startsWith("typography."))&&($({property:o,value:n}),o.includes(".")&&(o.startsWith("palette")||o.startsWith("layout")||o.startsWith("typography"))))return;const a=document.querySelectorAll(`[data-zflex-show="${o}"]`);if(a.length>0){const s=String(n)==="true";a.forEach(c=>{c.style.setProperty("display",s?"":"none","important")})}if(o==="howItWorks.showIcons")return;const r=document.querySelector(`[data-zflex-id="${o}"]`);if(!r){e?h(o,e):a.length===0&&console.warn(`[Preview] Ã‰lÃ©ment introuvable : ${o}`);return}const l=r.tagName.toUpperCase();if(l==="IMG")r.src=n,r.alt||(r.alt="Image");else if(l==="I"||r.classList.contains("fa")||r.classList.contains("fas")||r.classList.contains("fab")||r.classList.contains("far")||r.classList.contains("fal")||o.includes(".icon")){let s=String(n).trim();if(!s)return;!s.startsWith("fa-")&&!s.includes(" ")&&(s=`fa-${s}`),!s.includes("fas")&&!s.includes("fab")&&!s.includes("far")&&!s.includes("fal")&&(s=`fas ${s}`);const c=Array.from(r.classList).filter(d=>!d.startsWith("fa-")&&d!=="fas"&&d!=="fab"&&d!=="far"&&d!=="fa");if(o.includes("features.items")){const d=r.closest(".feature-visual-wrapper");if(d){const u=d.querySelector(".feature-img-bind"),f=d.querySelector(".feature-icon-bind");if(u&&f){const p=!!n&&n!==""&&n!=="null",b=u,z=b.src&&!b.src.includes("undefined")&&!b.src.endsWith("/");u.style.display=z?"":"none",f.style.display=p&&!z?"":"none"}}}r.className=`${c.join(" ")} ${s}`}else if(o.toLowerCase().includes("image")||o.includes("bg")||o.includes("cover")){const s=r.style.backgroundImage;if(s&&s.includes("gradient")){const c=s.replace(/url\(['"]?.*?['"]?\)/,`url('${n}')`);r.style.backgroundImage=c}else r.style.backgroundImage=`url('${n}')`;if(o.includes("features.items")){const c=r.closest(".feature-visual-wrapper");if(c){const d=c.querySelector(".feature-img-bind"),u=c.querySelector(".feature-icon-bind");if(d&&u){const f=!!n&&n!==""&&n!=="null";d.style.display=f?"":"none",u.style.display=f?"none":""}}}}else{const s=document.querySelectorAll(`[data-zflex-show="${o}"]`);if(s.length>0){const c=String(n)==="true";s.forEach(d=>{d.style.setProperty("display",c?"":"none","important")}),c&&y(s[0]);return}/<[a-z][\s\S]*>/i.test(String(n))?r.innerHTML=String(n):r.textContent=String(n)}l!=="I"&&y(r)}function y(t){t&&(t.style.transition="transform 0.2s ease, outline 0.2s ease",t.style.outline="2px solid rgba(0, 229, 255, 0.5)",t.style.transform="scale(1.02)",t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{t.style.transform="",t.style.outline=""},400))}function k(t){const{id:e}=t;let o=document.querySelector(`[data-zflex-section="${e.toLowerCase()}"]`)||document.querySelector(`[data-zflex-id="${e}"]`)||document.getElementById(e);o?y(o):console.log(`[Preview] Highlight: Element ${e} not found.`)}function x(t){if(!t?.data)return;const e=t.data;if(e.source==="zflex-admin")switch(console.log("[Preview] Message reÃ§u de l'Ã©diteur:",e),e.action){case"updateElement":q(e.payload,e);break;case"updateStyle":$(e.payload);break;case"updatePalette":L(e.payload);break;case"updateRepeater":M(e.payload,e);break;case"updateVariant":T(e.payload);break;case"updateLayout":E(e.payload);break;case"highlight":k(e.payload);break;case"injectTemplate":C(e.payload);break;default:console.warn("[Preview] Action non reconnue:",e.action)}}window.addEventListener("message",x);function T(t){const{id:e,variant:o,data:n}=t,i=document.querySelector(`[data-zflex-variant-container="${e}"]`),a=document.querySelector(`template[data-zflex-variant="${e}.${o}"]`);if(!i||!a){console.warn(`[Preview] Impossible de changer le variant : ${e} -> ${o} (Template/Container missing)`);return}console.log(`[Preview] Swap variant ${e} vers ${o}`);const l=a.content.cloneNode(!0).firstElementChild;l&&(S(l,n,e),l.querySelectorAll("[data-zflex-repeater]").forEach(c=>{const d=c.getAttribute("data-zflex-repeater");if(!d)return;const u=d.split("."),f=u[u.length-1],p=n[f];Array.isArray(p)&&A(c,d,p)}),i.style.opacity="0",setTimeout(()=>{i.innerHTML="",i.appendChild(l),i.style.opacity="1"},150))}function A(t,e,o){const n=document.querySelector(`template[data-zflex-template="${e}"]`);n&&(t.innerHTML="",o.forEach((i,a)=>{const l=n.content.cloneNode(!0).firstElementChild;l&&(N(l,e,a),S(l,i,`${e}[${a}]`),t.appendChild(l))}))}function N(t,e,o){if(t.querySelectorAll("[data-zflex-bind]").forEach(i=>{const a=i.getAttribute("data-zflex-bind");i.setAttribute("data-zflex-id",`${e}[${o}].${a}`)}),t.hasAttribute("data-zflex-bind")){const i=t.getAttribute("data-zflex-bind");t.setAttribute("data-zflex-id",`${e}[${o}].${i}`)}}function S(t,e,o=""){const n=t.querySelectorAll("[data-zflex-bind]"),i=(a,r,l)=>{if(l==null)return;const s=a.tagName.toUpperCase();if(s==="IMG")a.src=String(l);else if(r==="icon"||a.tagName==="I"||a.classList.contains("fa")){let c=String(l).trim();if(c){!c.startsWith("fa-")&&!c.includes(" ")&&(c=`fa-${c}`),!c.includes("fas")&&!c.includes("fab")&&(c=`fas ${c}`);const d=Array.from(a.classList).filter(u=>!u.startsWith("fa")&&u!=="fas"&&u!=="fab");a.className=`${d.join(" ")} ${c}`}}else if(r.includes("image")||r.includes("bg")||r.includes("cover")){if(s!=="IMG"){const c=a.style.backgroundImage||window.getComputedStyle(a).backgroundImage;if(c&&c.includes("gradient")){const d=c.replace(/url\(['"]?.*?['"]?\)/,`url('${l}')`);a.style.backgroundImage=d}else a.style.backgroundImage=`url('${l}')`}}else r==="image_position"?l==="left"?(a.classList.remove("image-right"),a.classList.add("image-left")):(a.classList.remove("image-left"),a.classList.add("image-right")):r==="style"&&a.classList.contains("reveal-section")?a.className=a.className.replace(/style-\w+/,`style-${l}`):a.textContent=String(l)};if(n.forEach(a=>{const r=a.getAttribute("data-zflex-bind");r&&i(a,r,e[r])}),t.hasAttribute("data-zflex-bind")){const a=t.getAttribute("data-zflex-bind");a&&i(t,a,e[a])}if(o.includes("reveal")&&e.image_position){const a=t.querySelector(".reveal-grid");a&&i(a,"image_position",e.image_position)}}function M(t,e){const{id:o,items:n}=t,i=document.querySelector(`[data-zflex-repeater="${o}"]`);i?(console.log(`[Preview] RÃ©gÃ©nÃ©ration du repeater ${o}`),A(i,o,n),i.style.transition="opacity 0.2s",i.style.opacity="0.5",setTimeout(()=>i.style.opacity="1",200)):e?h(o,e):console.warn(`[Preview] Repeater container not found: ${o}`)}function W(){console.log("[Preview] Activating Interaction Hijacking (Anti-Navigation)"),document.addEventListener("click",t=>{const e=t.target.closest("a, button, input[type='submit']");if(!e)return;if(e.classList.contains("btn-primary")||e.id.includes("add-to-cart")||e.textContent?.toLowerCase().includes("commander")||e.closest("#cart-btn")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Action commerciale bloquÃ©e:",e);return}if(e.tagName==="A"){const n=e.getAttribute("href");if(n&&n!=="#"&&!n.startsWith("javascript:")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Navigation bloquÃ©e:",n);return}}console.log("âœ… [Preview] Interaction autorisÃ©e:",e)},!0),document.addEventListener("submit",t=>{t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Soumission de formulaire bloquÃ©e.")},!0)}function j(){window.__ZFLEX_PREVIEW_MODE__=!0,console.log("ðŸš« [Preview] Analytics neutralized via Global Flag.")}window.parent!==window&&window.parent.postMessage({source:"zflex-preview",action:"ready",payload:{url:window.location.href}},"*")}export{_ as initPreviewMode};
