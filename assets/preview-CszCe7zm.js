function _(){console.log("[Preview] Initialisation du mode Ã©diteur temps rÃ©el (FOCUS V2 - LIVE ARCHITECTURE)"),k(),q();const m={"palette.primary":"--primary-color","palette.secondary":"--secondary-color","palette.background":"--bg-color","palette.text":"--text-color","palette.accent":"--accent-color","palette.cardBackground":"--card-bg-color","palette.textMuted":"--text-muted-color","palette.cardBorder":"--card-border-color","palette.inputBackground":"--input-bg-color","palette.chatResponseBackground":"--chat-response-bg-color",primary:"--primary-color",secondary:"--secondary-color",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardBackground:"--card-bg-color","primary-color":"--primary-color","bg-color":"--bg-color","card-bg-color":"--card-bg-color"};function f(o){if(!o)return null;if(typeof o=="string"&&o.startsWith("--"))return o;const e=String(o).trim(),n={"layout.borderRadius":"--border-radius","typography.headingFont":"--heading-font","typography.bodyFont":"--body-font","header.style":""};if(n[e])return n[e]||null;if(m[e])return m[e];const r=e.replace(/^(palette|layout|typography)[\._-]?/i,"").replace(/\./g,"").replace(/_/g,"").toLowerCase(),i={primary:"--primary-color",primary600:"--primary-600",primary700:"--primary-700",secondary:"--secondary-color",secondary600:"--secondary-600",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardbackground:"--card-bg-color",textmuted:"--text-muted-color",cardborder:"--card-border-color",inputbackground:"--input-bg-color",chatresponsebackground:"--chat-response-bg-color",borderradius:"--border-radius",headingfont:"--heading-font",bodyfont:"--body-font"};return i[r]?i[r]:`--${e.replace(/^(palette|layout|typography)[\._-]?/i,"").replace(/\./g,"-").replace(/_/g,(s,a)=>a>0?"-":"").replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`}function v(o={}){if(!o||typeof o!="object")return;const e=document.documentElement;Object.keys(o).forEach(n=>{const r=o[n];if(typeof r!="string"&&typeof r!="number")return;const i=n.startsWith("--")?n:f(n)||`--${n}`;e.style.setProperty(i,String(r))}),window.requestAnimationFrame(()=>{document.body.offsetHeight})}function S(o){const{sections:e}=o,n=document.querySelector('main[data-zflex-page-type="home"]');if(!n)return;console.log("[Preview] Syncing layout...",e);const r=Array.from(n.children).filter(s=>s.hasAttribute("data-zflex-section")),i=e.map(s=>s.type);let t=[];if(r.forEach(s=>{const a=s.getAttribute("data-zflex-section");a&&!i.includes(a)&&(console.log(`[Preview] Removing section ${a}`),s.remove())}),e.forEach(s=>{const a=n.querySelector(`[data-zflex-section="${s.type}"]`);a?n.appendChild(a):(console.log(`[Preview] Missing section ${s.type}`),t.push(s.type))}),t.length>0){console.warn(`[Preview] ${t.length} sections missing. Waiting for live injection or artifact refresh...`);const s=sessionStorage.getItem("__zflex_last_reload"),a=Date.now();if(s&&a-parseInt(s)<1e4){console.error("ðŸš« [Preview] RELOAD GUARD ACTIVE: Reload loop detected. Aborting reload.");return}setTimeout(()=>{t.some(c=>!n.querySelector(`[data-zflex-section="${c}"]`))&&(console.log("[Preview] Sections still missing after wait. Triggering safe reload."),sessionStorage.setItem("__zflex_last_reload",a.toString()),window.location.reload())},2e3)}}function x(o){const{type:e,html:n}=o,r=document.querySelector('main[data-zflex-page-type="home"]');if(!r)return;console.log(`[Preview] Injecting template for ${e}...`);const i=document.createElement("div");i.innerHTML=n.trim();const t=i.firstElementChild;if(t){t.setAttribute("data-zflex-section",e);const s=r.querySelector(`[data-zflex-section="${e}"]`);s?s.replaceWith(t):r.appendChild(t),console.log(`[Preview] Section ${e} injected successfully.`),t.style.animation="pulse-glow 1s ease-in-out"}}function A(o){if(!o)return;const e=o.computed||{},n=o.palette||{},r={};Object.keys(n).forEach(i=>{const t=f(i)||f(`palette.${i}`)||`--${i}`;t&&(r[t]=n[i])}),Object.keys(e).forEach(i=>{const t=f(i)||`--${i.replace(/[A-Z]/g,s=>"-"+s.toLowerCase())}`;t&&(r[t]=e[i])}),v(r),console.log("[Preview] Applied computed palette vars:",r)}function z(o){if(o==null)return"";let e=String(o).trim();return/^[0-9A-Fa-f]{6}$/.test(e)&&(e="#"+e),e}function b(o){if(!o)return;let{property:e,value:n}=o;const r=f(e)||e,i=z(n);r&&(document.documentElement.style.setProperty(r,i),(r.includes("color")||r.includes("bg")||r.includes("background"))&&(document.body.style.transition="background-color 0.22s ease, color 0.22s ease, border-color 0.22s ease",setTimeout(()=>{document.body.style.transition=""},300)),console.log(`[Preview] Mise Ã  jour style (incoming: ${String(e)}) -> canonical: ${r}: ${i}`))}function E(o){if(!o)return;const{id:e,value:n}=o,r=f(e);if(r&&(r.startsWith("--")||e.startsWith("palette.")||e.startsWith("layout.")||e.startsWith("typography."))&&(b({property:e,value:n}),e.includes(".")&&(e.startsWith("palette")||e.startsWith("layout")||e.startsWith("typography"))))return;const i=document.querySelectorAll(`[data-zflex-show="${e}"]`);if(i.length>0){const a=String(n)==="true";i.forEach(l=>{l.style.setProperty("display",a?"":"none","important")}),a&&g(i[0])}if(e==="howItWorks.showIcons")return;const t=document.querySelector(`[data-zflex-id="${e}"]`);if(!t){i.length===0&&console.warn(`[Preview] Ã‰lÃ©ment introuvable : ${e}`);return}const s=t.tagName.toUpperCase();if(s==="IMG")t.src=n,t.alt||(t.alt="Image");else if(s==="I"||t.classList.contains("fa")||t.classList.contains("fas")||t.classList.contains("fab")||t.classList.contains("far")||t.classList.contains("fal")||e.includes(".icon")){let a=String(n).trim();if(!a)return;!a.startsWith("fa-")&&!a.includes(" ")&&(a=`fa-${a}`),!a.includes("fas")&&!a.includes("fab")&&!a.includes("far")&&!a.includes("fal")&&(a=`fas ${a}`);const l=Array.from(t.classList).filter(c=>!c.startsWith("fa-")&&c!=="fas"&&c!=="fab"&&c!=="far"&&c!=="fa");if(e.includes("features.items")){const c=t.closest(".feature-visual-wrapper");if(c){const d=c.querySelector(".feature-img-bind"),u=c.querySelector(".feature-icon-bind");if(d&&u){const y=!!n&&n!==""&&n!=="null",p=d,$=p.src&&!p.src.includes("undefined")&&!p.src.endsWith("/");d.style.display=$?"":"none",u.style.display=y&&!$?"":"none"}}}t.className=`${l.join(" ")} ${a}`}else if(e.toLowerCase().includes("image")||e.includes("bg")||e.includes("cover")){const a=t.style.backgroundImage;if(a&&a.includes("gradient")){const l=a.replace(/url\(['"]?.*?['"]?\)/,`url('${n}')`);t.style.backgroundImage=l}else t.style.backgroundImage=`url('${n}')`;if(e.includes("features.items")){const l=t.closest(".feature-visual-wrapper");if(l){const c=l.querySelector(".feature-img-bind"),d=l.querySelector(".feature-icon-bind");if(c&&d){const u=!!n&&n!==""&&n!=="null";c.style.display=u?"":"none",d.style.display=u?"none":""}}}}else{const a=document.querySelectorAll(`[data-zflex-show="${e}"]`);if(a.length>0){const l=String(n)==="true";a.forEach(c=>{c.style.setProperty("display",l?"":"none","important")}),l&&g(a[0]);return}/<[a-z][\s\S]*>/i.test(String(n))?t.innerHTML=String(n):t.textContent=String(n)}s!=="I"&&g(t)}function g(o){o&&(o.style.transition="transform 0.2s ease, outline 0.2s ease",o.style.outline="2px solid rgba(0, 229, 255, 0.5)",o.style.transform="scale(1.02)",o.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{o.style.transform="",o.style.outline=""},400))}function P(o){const{id:e}=o;let n=document.querySelector(`[data-zflex-section="${e.toLowerCase()}"]`)||document.querySelector(`[data-zflex-id="${e}"]`)||document.getElementById(e);n?g(n):console.log(`[Preview] Highlight: Element ${e} not found.`)}window.addEventListener("message",o=>{if(!o?.data)return;const e=o.data;if(e.source==="zflex-admin")switch(console.log("[Preview] Message reÃ§u de l'Ã©diteur:",e),e.action){case"updateElement":E(e.payload);break;case"updateStyle":b(e.payload);break;case"updatePalette":A(e.payload);break;case"updateRepeater":L(e.payload);break;case"updateVariant":I(e.payload);break;case"updateLayout":S(e.payload);break;case"highlight":P(e.payload);break;case"injectTemplate":x(e.payload);break;default:console.warn("[Preview] Action non reconnue:",e.action)}});function I(o){const{id:e,variant:n,data:r}=o,i=document.querySelector(`[data-zflex-variant-container="${e}"]`),t=document.querySelector(`template[data-zflex-variant="${e}.${n}"]`);if(!i||!t){console.warn(`[Preview] Impossible de changer le variant : ${e} -> ${n} (Template/Container missing)`);return}console.log(`[Preview] Swap variant ${e} vers ${n}`);const a=t.content.cloneNode(!0).firstElementChild;a&&(w(a,r,e),a.querySelectorAll("[data-zflex-repeater]").forEach(c=>{const d=c.getAttribute("data-zflex-repeater");if(!d)return;const u=d.split("."),y=u[u.length-1],p=r[y];Array.isArray(p)&&h(c,d,p)}),i.style.opacity="0",setTimeout(()=>{i.innerHTML="",i.appendChild(a),i.style.opacity="1"},150))}function h(o,e,n){const r=document.querySelector(`template[data-zflex-template="${e}"]`);r&&(o.innerHTML="",n.forEach((i,t)=>{const a=r.content.cloneNode(!0).firstElementChild;a&&(C(a,e,t),w(a,i,`${e}[${t}]`),o.appendChild(a))}))}function C(o,e,n){if(o.querySelectorAll("[data-zflex-bind]").forEach(i=>{const t=i.getAttribute("data-zflex-bind");i.setAttribute("data-zflex-id",`${e}[${n}].${t}`)}),o.hasAttribute("data-zflex-bind")){const i=o.getAttribute("data-zflex-bind");o.setAttribute("data-zflex-id",`${e}[${n}].${i}`)}}function w(o,e,n=""){const r=o.querySelectorAll("[data-zflex-bind]"),i=(t,s,a)=>{if(a==null)return;const l=t.tagName.toUpperCase();if(l==="IMG")t.src=String(a);else if(s==="icon"||t.tagName==="I"||t.classList.contains("fa")){let c=String(a).trim();if(c){!c.startsWith("fa-")&&!c.includes(" ")&&(c=`fa-${c}`),!c.includes("fas")&&!c.includes("fab")&&(c=`fas ${c}`);const d=Array.from(t.classList).filter(u=>!u.startsWith("fa")&&u!=="fas"&&u!=="fab");t.className=`${d.join(" ")} ${c}`}}else if(s.includes("image")||s.includes("bg")||s.includes("cover")){if(l!=="IMG"){const c=t.style.backgroundImage||window.getComputedStyle(t).backgroundImage;if(c&&c.includes("gradient")){const d=c.replace(/url\(['"]?.*?['"]?\)/,`url('${a}')`);t.style.backgroundImage=d}else t.style.backgroundImage=`url('${a}')`}}else s==="image_position"?a==="left"?(t.classList.remove("image-right"),t.classList.add("image-left")):(t.classList.remove("image-left"),t.classList.add("image-right")):s==="style"&&t.classList.contains("reveal-section")?t.className=t.className.replace(/style-\w+/,`style-${a}`):t.textContent=String(a)};if(r.forEach(t=>{const s=t.getAttribute("data-zflex-bind");s&&i(t,s,e[s])}),o.hasAttribute("data-zflex-bind")){const t=o.getAttribute("data-zflex-bind");t&&i(o,t,e[t])}if(n.includes("reveal")&&e.image_position){const t=o.querySelector(".reveal-grid");t&&i(t,"image_position",e.image_position)}}function L(o){const{id:e,items:n}=o,r=document.querySelector(`[data-zflex-repeater="${e}"]`);r?(console.log(`[Preview] RÃ©gÃ©nÃ©ration du repeater ${e}`),h(r,e,n),r.style.transition="opacity 0.2s",r.style.opacity="0.5",setTimeout(()=>r.style.opacity="1",200)):console.warn(`[Preview] Repeater container not found: ${e}`)}function k(){console.log("[Preview] Activating Interaction Hijacking (Anti-Navigation)"),document.addEventListener("click",o=>{const e=o.target.closest("a, button, input[type='submit']");if(!e)return;if(e.classList.contains("btn-primary")||e.id.includes("add-to-cart")||e.textContent?.toLowerCase().includes("commander")||e.closest("#cart-btn")){o.preventDefault(),o.stopPropagation(),console.log("ðŸš« [Preview] Action commerciale bloquÃ©e:",e);return}if(e.tagName==="A"){const r=e.getAttribute("href");if(r&&r!=="#"&&!r.startsWith("javascript:")){o.preventDefault(),o.stopPropagation(),console.log("ðŸš« [Preview] Navigation bloquÃ©e:",r);return}}console.log("âœ… [Preview] Interaction autorisÃ©e:",e)},!0),document.addEventListener("submit",o=>{o.preventDefault(),o.stopPropagation(),console.log("ðŸš« [Preview] Soumission de formulaire bloquÃ©e.")},!0)}function q(){window.__ZFLEX_PREVIEW_MODE__=!0,console.log("ðŸš« [Preview] Analytics neutralized via Global Flag.")}window.parent!==window&&window.parent.postMessage({source:"zflex-preview",action:"ready",payload:{url:window.location.href}},"*")}export{_ as initPreviewMode};
