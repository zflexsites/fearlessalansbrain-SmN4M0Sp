import{g as U,a as V,e as R,c as _,i as j,b as H,d as F,n as G}from"./app-Ch-PXCTG.js";function N(){try{const e=document.getElementById("zflex-data")||document.querySelector(".zflex-fragment-data");return!e||!e.textContent?(console.warn("[Checkout] Tunnel de data est vide ou introuvable."),{}):JSON.parse(e.textContent)}catch(e){return console.error("[Checkout] Erreur de parsing du tunnel de data:",e),{}}}function J(){return Math.random().toString(36).slice(2,9)}function K(e){return`${e}-${Date.now()}-${J()}`}function D(e){return e==null?"":String(e)}function Q(e){if(e){if(typeof e.transactionStatus=="string")return e.transactionStatus;if(e.result&&typeof e.result.transactionStatus=="string")return e.result.transactionStatus;if(e.data&&typeof e.data.transactionStatus=="string")return e.data.transactionStatus;if(typeof e.status=="string")return e.status}}function W(e){if(e)return e.error||e.message||e.result?.error||e.result?.message||e.data?.error}function X(e){const t=document.getElementById("summary-items-list"),l=document.getElementById("summary-subtotal"),S=document.getElementById("summary-total");if(!t||!l||!S)return;if(!e||e.length===0){t.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>',l.innerHTML="",S.innerHTML="";return}t.innerHTML="";const E={};e.forEach(p=>{const x=document.createElement("div");x.className="flex justify-between items-center text-sm mb-4";const C=p.coverImage||"https://via.placeholder.com/64?text=No+Image",g=p.title||"Produit",y=p.price?.amount||0,L=p.price?.currency||"EUR",u=p.quantity||1;x.innerHTML=`
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 flex-shrink-0 border rounded overflow-hidden" style="border-color: var(--card-border-color);">
          <img src="${C}" alt="${g}" class="w-full h-full object-cover">
        </div>
        <div>
          <div class="font-medium" style="color: var(--text-color);">
            <span class="font-bold text-xs px-1 py-0.5 rounded mr-1" style="background-color: var(--card-bg-color);">${u}x</span> 
            ${g}
          </div>
        </div>
      </div>
      <span class="font-medium whitespace-nowrap ml-2" style="color: var(--text-color);">
        ${(y*u).toFixed(2)} ${L}
      </span>
    `,t.appendChild(x),E[L]||(E[L]=0),E[L]+=y*u}),l.innerHTML="",S.innerHTML="",Object.entries(E).forEach(([p,x])=>{const C=`${Number(x).toFixed(2)} ${p}`;l.innerHTML+=`<div style="color: var(--text-color);">${C}</div>`,S.innerHTML+=`<div style="color: var(--text-color);">${C}</div>`})}function Z(){const e=document.getElementById("checkout-form");if(!e)return;const t=document.getElementById("checkout-error");let l=null;const S=async o=>{const i=localStorage.getItem("zflex_prospectId");if(!(!i||!o))try{const r=await V(o,i);r.success&&r.data&&R.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"On vous reconnaît !",message:"Voulez-vous utiliser les informations de votre dernière visite ?",messageHtml:`
                <div style="display:flex;gap:12px;align-items:center">
                  <div style="width:56px;height:56px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:600;color:#111">${(r.data.name||"U").charAt(0)}</div>
                  <div>
                    <div>Nom: <strong>${D(r.data.name)}</strong></div>
                    <div>Tél: <strong>${D(r.data.phone)}</strong></div>
                    <div style="color:#6b7280">${D(r.data.address)}</div>
                  </div>
                </div>
              `,confirmText:"Oui, utiliser",cancelText:"Non, merci",variant:"info",onConfirm:()=>{const n=e.elements;n.name&&(n.name.value=r.data?.name||""),n.email&&(n.email.value=r.data?.email||""),n.phone&&(n.phone.value=r.data?.phone||""),n.address&&(n.address.value=r.data?.address||""),n.notes&&(n.notes.value=r.data?.notes||"")}}}))}catch(r){console.warn("Impossible de récupérer les infos du prospect/client:",r?.message||r),String(r?.message||"").includes("Aucune information")&&localStorage.removeItem("zflex_prospectId")}},E=N().storeId;if(!E){console.error("[Checkout] Erreur critique : ID du store non trouvé à l'initialisation.");const o=document.querySelector(".lg\\:col-span-3");o&&(o.innerHTML='<div class="text-red-500 p-4 border border-red-200 rounded-lg bg-red-50"><strong>Erreur de chargement.</strong> Impossible de récupérer les informations de la boutique. Veuillez rafraîchir la page.</div>');return}S(E);const p=U()||[];X(p);const x=document.getElementById("step-address"),C=document.getElementById("step-payment"),g=document.getElementById("continue-to-payment-btn"),y=document.getElementById("progress-bar"),L=document.getElementById("checkout-title"),u=document.getElementById("submit-order-btn"),b=document.getElementById("payment-phone"),z=document.getElementById("operator-logo-container"),T=document.getElementById("selected-payment-method"),$=document.getElementById("payment-instructions"),v=document.getElementById("use-geolocation-btn"),q=document.getElementById("address");if(!g||!u||!t){console.error("[Checkout] Éléments DOM critiques manquants (boutons ou erreur).");return}const P=async(o,i,r=null)=>{const n=(o||"").toUpperCase(),s=u.querySelector(".btn-spinner"),a=u.querySelector(".btn-text");if(n==="SUCCESS"||n==="SUCCEEDED"||n==="COMPLETED"){s&&s.classList.add("hidden"),a&&(a.textContent="Paiement réussi ! Redirection..."),y&&(y.style.width="100%"),setTimeout(()=>{F();try{G(`/order-success/?id=${encodeURIComponent(l||"")}`)}catch{window.location.href=`/order-success/?id=${encodeURIComponent(l||"")}`}},900);return}if(n==="PENDING"){s&&s.classList.add("hidden"),u.disabled=!1,a&&(a.textContent="Statut: En attente de confirmation"),y&&(y.style.width="95%"),t.textContent=i||"La transaction est en attente. Veuillez confirmer sur votre téléphone.",t.classList.remove("hidden");return}s&&s.classList.add("hidden"),u.disabled=!1,a&&(a.textContent="Confirmer et Payer"),t.textContent=i||"Le paiement a échoué. Veuillez réessayer ou contacter le support.",t.classList.remove("hidden")},O=async()=>{t.classList.add("hidden");const o=e.elements,i=o.name.value.trim(),r=o.email.value.trim(),n=o.phone.value.trim(),s=o.address.value.trim();if(!i||!r||!n||!s){t.textContent="Veuillez remplir tous les champs requis.",t.classList.remove("hidden");return}g.disabled=!0,g.textContent="Enregistrement...";try{const a={name:i,email:r,phone:n,address:s,notes:o.notes?.value.trim()||""},f=p.reduce((h,m)=>h+m.price.amount*m.quantity,0),w={customer:a,items:p,total:f,currency:p[0]?.price.currency||"EUR"},c=await _(w,E);if(!c.success||!c.orderId)throw new Error(c.error||"La création de la pré-commande a échoué.");l=c.orderId,c.readableId&&localStorage.setItem(`zflex_readable_${l}`,c.readableId),c.prospectId&&localStorage.setItem("zflex_prospectId",c.prospectId),x&&x.classList.add("hidden"),C&&C.classList.remove("hidden"),y&&(y.style.width="60%"),L&&(L.textContent="Étape 2: Paiement")}catch(a){t.textContent=a.message||"Une erreur est survenue.",t.classList.remove("hidden"),g.disabled=!1,g.textContent="Continuer vers le paiement"}},A=async o=>{if(o.preventDefault(),t.classList.add("hidden"),!l){t.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",t.classList.remove("hidden");return}const i=T?.value,n=(b?.value||"").replace(/\D/g,"");if(!i||!n||n.length<9){t.textContent="Veuillez entrer un numéro de paiement valide pour détecter l'opérateur.",t.classList.remove("hidden");return}u.disabled=!0;const s=u.querySelector(".btn-text"),a=u.querySelector(".btn-spinner");s&&(s.textContent="Initiation du paiement..."),a&&a.classList.remove("hidden");const f=`zflex_txref_${l}`;let w=localStorage.getItem(f);if(!w){w=K(l);try{localStorage.setItem(f,w)}catch{}}try{const c=N().storeId;if(!c)throw new Error("Erreur de configuration : ID du store manquant.");const h=await j(l,c,i,`+243${n}`,w),m=W(h),M=Q(h);if(m)if(String(m).toLowerCase().includes("transactionreference already exists")||String(m).toLowerCase().includes("transactionreference")&&String(m).toLowerCase().includes("exists"))try{const I=await H(l,c),d=I,B=d.transactionStatus||d.result?.transactionStatus||d.status||d.data?.transactionStatus||d.statusText||(d.success?d.result?.transactionStatus:void 0),k=d.message||d.result?.message||d.error||"La transaction existe déjà. Nous vérifions son statut.";await P(B,k,I);return}catch{t.textContent="Impossible de vérifier le statut de la transaction existante.",t.classList.remove("hidden"),a&&a.classList.add("hidden"),u.disabled=!1,s&&(s.textContent="Confirmer et Payer");return}else throw new Error(String(m));if(M)if(M.toUpperCase()==="PENDING"){await P("PENDING","Veuillez confirmer sur votre téléphone...");return}else if(["SUCCESS","SUCCEEDED","COMPLETED"].includes(M.toUpperCase())){await P("SUCCESS","Paiement confirmé.");return}else throw new Error(`Statut de transaction inattendu: ${M}`);try{const I=await H(l,c),d=I,B=d.transactionStatus||d.result?.transactionStatus||d.status||d.data?.transactionStatus,k=d.message||d.result?.message||"";await P(B,k,I)}catch{throw new Error("Statut de transaction inattendu.")}}catch(c){const h=c?.message||String(c);let m="Le lancement du paiement a échoué.";h.includes("transactionReference already exists")?m="Une tentative existe déjà. Vérification...":h.includes("transactionReference")?m="Erreur de référence. Rafraîchissez la page.":h.includes("aucun opérateur")||h.toLowerCase().includes("operator")?m="Opérateur non supporté pour ce numéro.":m=h,t.textContent=m,t.classList.remove("hidden"),a&&a.classList.add("hidden"),u.disabled=!1,s&&(s.textContent="Confirmer et Payer")}};return g.addEventListener("click",O),b&&b.addEventListener("input",()=>{const i=(b.value||"").replace(/\D/g,"").substring(0,2),r=["81","82","83"],n=["80","84","85","89"],s=["97","99"],a=["90"];let f="";r.includes(i)&&(f="MPESA"),n.includes(i)&&(f="ORANGE"),s.includes(i)&&(f="AIRTEL"),a.includes(i)&&(f="AFRICELL"),z&&(z.innerHTML=""),f&&T&&$?(T.value=f,$.innerHTML=`<p>Opérateur <strong>${f}</strong> détecté. Vous recevrez une notification pour valider.</p>`):T&&$&&(T.value="",$.innerHTML="<p>Veuillez entrer un numéro valide pour détecter l'opérateur.</p>")}),v&&v.addEventListener("click",()=>{if(!navigator.geolocation){t.textContent="La géolocalisation n'est pas supportée.",t.classList.remove("hidden");return}v.disabled=!0,v.classList.add("animate-pulse"),navigator.geolocation.getCurrentPosition(async o=>{const{latitude:i,longitude:r}=o.coords;try{const s=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${i}&lon=${r}`)).json();if(s&&s.display_name&&q)q.value=s.display_name;else throw new Error("Adresse non trouvée.")}catch{t.textContent="Impossible de récupérer l'adresse.",t.classList.remove("hidden")}finally{v.disabled=!1,v.classList.remove("animate-pulse")}},o=>{t.textContent="Erreur de géolocalisation ("+o.code+")",t.classList.remove("hidden"),v.disabled=!1,v.classList.remove("animate-pulse")},{timeout:1e4,enableHighAccuracy:!0})}),e.addEventListener("submit",A),console.log("[Checkout] Module V13.0 initialisé."),{destroy:()=>{g.removeEventListener("click",O),b&&b.removeEventListener("input",()=>{}),v&&v.removeEventListener("click",()=>{}),e.removeEventListener("submit",A),console.log("[Checkout] Module détruit.")}}}export{Z as initCheckout};
