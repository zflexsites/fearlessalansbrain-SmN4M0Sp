function q(){console.log("[Preview] Initialisation du mode Ã©diteur temps rÃ©el (FOCUS V2 - LIVE ARCHITECTURE)"),L(),k();const m={"palette.primary":"--primary-color","palette.secondary":"--secondary-color","palette.background":"--bg-color","palette.text":"--text-color","palette.accent":"--accent-color","palette.cardBackground":"--card-bg-color","palette.textMuted":"--text-muted-color","palette.cardBorder":"--card-border-color","palette.inputBackground":"--input-bg-color","palette.chatResponseBackground":"--chat-response-bg-color",primary:"--primary-color",secondary:"--secondary-color",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardBackground:"--card-bg-color","primary-color":"--primary-color","bg-color":"--bg-color","card-bg-color":"--card-bg-color"};function f(o){if(!o)return null;if(typeof o=="string"&&o.startsWith("--"))return o;const e=String(o).trim(),a={"layout.borderRadius":"--border-radius","typography.headingFont":"--heading-font","typography.bodyFont":"--body-font","header.style":""};if(a[e])return a[e]||null;if(m[e])return m[e];const n=e.replace(/^palette[\._-]?/i,"").replace(/\./g,"").replace(/_/g,"").toLowerCase(),s={primary:"--primary-color",primary600:"--primary-600",primary700:"--primary-700",secondary:"--secondary-color",secondary600:"--secondary-600",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardbackground:"--card-bg-color",textmuted:"--text-muted-color",cardborder:"--card-border-color",inputbackground:"--input-bg-color",chatresponsebackground:"--chat-response-bg-color",borderradius:"--border-radius",headingfont:"--heading-font",bodyfont:"--body-font"};return s[n]?s[n]:`--${e.replace(/^palette[\._-]?/i,"").replace(/\./g,"-").replace(/_/g,(i,r)=>r>0?"-":"").replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`}function w(o={}){if(!o||typeof o!="object")return;const e=document.documentElement;Object.keys(o).forEach(a=>{const n=o[a];if(typeof n!="string"&&typeof n!="number")return;const s=a.startsWith("--")?a:f(a)||`--${a}`;e.style.setProperty(s,String(n))}),window.requestAnimationFrame(()=>{document.body.offsetHeight})}function $(o){const{sections:e}=o,a=document.querySelector('main[data-zflex-page-type="home"]');if(!a)return;console.log("[Preview] Syncing layout...",e);const n=Array.from(a.children).filter(i=>i.hasAttribute("data-zflex-section")),s=e.map(i=>i.type);let t=[];if(n.forEach(i=>{const r=i.getAttribute("data-zflex-section");r&&!s.includes(r)&&(console.log(`[Preview] Removing section ${r}`),i.remove())}),e.forEach(i=>{const r=a.querySelector(`[data-zflex-section="${i.type}"]`);r?a.appendChild(r):(console.log(`[Preview] Missing section ${i.type}`),t.push(i.type))}),t.length>0){console.warn(`[Preview] ${t.length} sections missing. Waiting for live injection or artifact refresh...`);const i=sessionStorage.getItem("__zflex_last_reload"),r=Date.now();if(i&&r-parseInt(i)<1e4){console.error("ðŸš« [Preview] RELOAD GUARD ACTIVE: Reload loop detected. Aborting reload.");return}setTimeout(()=>{t.some(c=>!a.querySelector(`[data-zflex-section="${c}"]`))&&(console.log("[Preview] Sections still missing after wait. Triggering safe reload."),sessionStorage.setItem("__zflex_last_reload",r.toString()),window.location.reload())},2e3)}}function v(o){const{type:e,html:a}=o,n=document.querySelector('main[data-zflex-page-type="home"]');if(!n)return;console.log(`[Preview] Injecting template for ${e}...`);const s=document.createElement("div");s.innerHTML=a.trim();const t=s.firstElementChild;if(t){t.setAttribute("data-zflex-section",e);const i=n.querySelector(`[data-zflex-section="${e}"]`);i?i.replaceWith(t):n.appendChild(t),console.log(`[Preview] Section ${e} injected successfully.`),t.style.animation="pulse-glow 1s ease-in-out"}}function S(o){if(!o)return;const e=o.computed||{},a=o.palette||{},n={};Object.keys(a).forEach(s=>{const t=f(s)||f(`palette.${s}`)||`--${s}`;t&&(n[t]=a[s])}),Object.keys(e).forEach(s=>{const t=f(s)||`--${s.replace(/[A-Z]/g,i=>"-"+i.toLowerCase())}`;t&&(n[t]=e[s])}),w(n),console.log("[Preview] Applied computed palette vars:",n)}function x(o){if(o==null)return"";let e=String(o).trim();return/^[0-9A-Fa-f]{6}$/.test(e)&&(e="#"+e),e}function A(o){if(!o)return;let{property:e,value:a}=o;const n=f(e)||e,s=x(a);n&&(document.documentElement.style.setProperty(n,s),(n.includes("color")||n.includes("bg")||n.includes("background"))&&(document.body.style.transition="background-color 0.22s ease, color 0.22s ease, border-color 0.22s ease",setTimeout(()=>{document.body.style.transition=""},300)),console.log(`[Preview] Mise Ã  jour style (incoming: ${String(e)}) -> canonical: ${n}: ${s}`))}function z(o){if(!o)return;const{id:e,value:a}=o,n=document.querySelector(`[data-zflex-id="${e}"]`);if(!n){console.warn(`[Preview] Ã‰lÃ©ment introuvable : ${e}`);return}const s=n.tagName.toUpperCase();if(s==="IMG")n.src=a,n.alt||(n.alt="Image");else if(s==="I"||n.classList.contains("fa")||n.classList.contains("fas")||n.classList.contains("fab")||e.includes(".icon")){let t=String(a).trim();if(!t)return;!t.startsWith("fa-")&&!t.includes(" ")&&(t=`fa-${t}`),!t.includes("fas")&&!t.includes("fab")&&!t.includes("far")&&!t.includes("fal")&&(t=`fas ${t}`);const i=Array.from(n.classList).filter(r=>!r.startsWith("fa-")&&r!=="fas"&&r!=="fab"&&r!=="far"&&r!=="fa");if(e.includes("features.items")){const r=n.closest(".feature-visual-wrapper");if(r){const l=r.querySelector(".feature-img-bind"),c=r.querySelector(".feature-icon-bind");if(l&&c){const u=!!a&&a!==""&&a!=="null",d=l,p=d.src&&!d.src.includes("undefined")&&!d.src.endsWith("/");l.style.display=p?"":"none",c.style.display=u&&!p?"":"none"}}}n.className=`${i.join(" ")} ${t}`}else if(e.toLowerCase().includes("image")||e.includes("bg")||e.includes("cover")){const t=n.style.backgroundImage;if(t&&t.includes("gradient")){const i=t.replace(/url\(['"]?.*?['"]?\)/,`url('${a}')`);n.style.backgroundImage=i}else n.style.backgroundImage=`url('${a}')`;if(e.includes("features.items")){const i=n.closest(".feature-visual-wrapper");if(i){const r=i.querySelector(".feature-img-bind"),l=i.querySelector(".feature-icon-bind");if(r&&l){const c=!!a&&a!==""&&a!=="null";r.style.display=c?"":"none",l.style.display=c?"none":""}}}}else{const t=document.querySelectorAll(`[data-zflex-show="${e}"]`);if(t.length>0){const i=String(a)==="true"||a===!0;t.forEach(r=>{r.style.display=i?"":"none"}),i&&g(t[0]);return}/<[a-z][\s\S]*>/i.test(String(a))?n.innerHTML=String(a):n.textContent=String(a)}s!=="I"&&g(n)}function g(o){o&&(o.style.transition="transform 0.2s ease, outline 0.2s ease",o.style.outline="2px solid rgba(0, 229, 255, 0.5)",o.style.transform="scale(1.02)",o.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{o.style.transform="",o.style.outline=""},400))}function E(o){const{id:e}=o;let a=document.querySelector(`[data-zflex-section="${e.toLowerCase()}"]`)||document.querySelector(`[data-zflex-id="${e}"]`)||document.getElementById(e);a?g(a):console.log(`[Preview] Highlight: Element ${e} not found.`)}window.addEventListener("message",o=>{if(!o?.data)return;const e=o.data;if(e.source==="zflex-admin")switch(console.log("[Preview] Message reÃ§u de l'Ã©diteur:",e),e.action){case"updateElement":z(e.payload);break;case"updateStyle":A(e.payload);break;case"updatePalette":S(e.payload);break;case"updateRepeater":C(e.payload);break;case"updateVariant":P(e.payload);break;case"updateLayout":$(e.payload);break;case"highlight":E(e.payload);break;case"injectTemplate":v(e.payload);break;default:console.warn("[Preview] Action non reconnue:",e.action)}});function P(o){const{id:e,variant:a,data:n}=o,s=document.querySelector(`[data-zflex-variant-container="${e}"]`),t=document.querySelector(`template[data-zflex-variant="${e}.${a}"]`);if(!s||!t){console.warn(`[Preview] Impossible de changer le variant : ${e} -> ${a} (Template/Container missing)`);return}console.log(`[Preview] Swap variant ${e} vers ${a}`);const r=t.content.cloneNode(!0).firstElementChild;r&&(b(r,n,e),r.querySelectorAll("[data-zflex-repeater]").forEach(c=>{const u=c.getAttribute("data-zflex-repeater");if(!u)return;const d=u.split("."),p=d[d.length-1],h=n[p];Array.isArray(h)&&y(c,u,h)}),s.style.opacity="0",setTimeout(()=>{s.innerHTML="",s.appendChild(r),s.style.opacity="1"},150))}function y(o,e,a){const n=document.querySelector(`template[data-zflex-template="${e}"]`);n&&(o.innerHTML="",a.forEach((s,t)=>{const r=n.content.cloneNode(!0).firstElementChild;r&&(I(r,e,t),b(r,s,`${e}[${t}]`),o.appendChild(r))}))}function I(o,e,a){if(o.querySelectorAll("[data-zflex-bind]").forEach(s=>{const t=s.getAttribute("data-zflex-bind");s.setAttribute("data-zflex-id",`${e}[${a}].${t}`)}),o.hasAttribute("data-zflex-bind")){const s=o.getAttribute("data-zflex-bind");o.setAttribute("data-zflex-id",`${e}[${a}].${s}`)}}function b(o,e,a=""){const n=o.querySelectorAll("[data-zflex-bind]"),s=(t,i,r)=>{if(r==null)return;const l=t.tagName.toUpperCase();if(l==="IMG")t.src=String(r);else if(i==="icon"||t.tagName==="I"||t.classList.contains("fa")){let c=String(r).trim();if(c){!c.startsWith("fa-")&&!c.includes(" ")&&(c=`fa-${c}`),!c.includes("fas")&&!c.includes("fab")&&(c=`fas ${c}`);const u=Array.from(t.classList).filter(d=>!d.startsWith("fa")&&d!=="fas"&&d!=="fab");t.className=`${u.join(" ")} ${c}`}}else if(i.includes("image")||i.includes("bg")||i.includes("cover")){if(l!=="IMG"){const c=t.style.backgroundImage||window.getComputedStyle(t).backgroundImage;if(c&&c.includes("gradient")){const u=c.replace(/url\(['"]?.*?['"]?\)/,`url('${r}')`);t.style.backgroundImage=u}else t.style.backgroundImage=`url('${r}')`}}else i==="image_position"?r==="left"?(t.classList.remove("image-right"),t.classList.add("image-left")):(t.classList.remove("image-left"),t.classList.add("image-right")):i==="style"&&t.classList.contains("reveal-section")?t.className=t.className.replace(/style-\w+/,`style-${r}`):t.textContent=String(r)};if(n.forEach(t=>{const i=t.getAttribute("data-zflex-bind");i&&s(t,i,e[i])}),o.hasAttribute("data-zflex-bind")){const t=o.getAttribute("data-zflex-bind");t&&s(o,t,e[t])}if(a.includes("reveal")&&e.image_position){const t=o.querySelector(".reveal-grid");t&&s(t,"image_position",e.image_position)}}function C(o){const{id:e,items:a}=o,n=document.querySelector(`[data-zflex-repeater="${e}"]`);n?(console.log(`[Preview] RÃ©gÃ©nÃ©ration du repeater ${e}`),y(n,e,a),n.style.transition="opacity 0.2s",n.style.opacity="0.5",setTimeout(()=>n.style.opacity="1",200)):console.warn(`[Preview] Repeater container not found: ${e}`)}function L(){console.log("[Preview] Activating Interaction Hijacking (Anti-Navigation)"),document.addEventListener("click",o=>{const e=o.target.closest("a, button, input[type='submit']");if(!e)return;if(e.classList.contains("btn-primary")||e.id.includes("add-to-cart")||e.textContent?.toLowerCase().includes("commander")||e.closest("#cart-btn")){o.preventDefault(),o.stopPropagation(),console.log("ðŸš« [Preview] Action commerciale bloquÃ©e:",e);return}if(e.tagName==="A"){const n=e.getAttribute("href");if(n&&n!=="#"&&!n.startsWith("javascript:")){o.preventDefault(),o.stopPropagation(),console.log("ðŸš« [Preview] Navigation bloquÃ©e:",n);return}}console.log("âœ… [Preview] Interaction autorisÃ©e:",e)},!0),document.addEventListener("submit",o=>{o.preventDefault(),o.stopPropagation(),console.log("ðŸš« [Preview] Soumission de formulaire bloquÃ©e.")},!0)}function k(){window.__ZFLEX_PREVIEW_MODE__=!0,console.log("ðŸš« [Preview] Analytics neutralized via Global Flag.")}window.parent!==window&&window.parent.postMessage({source:"zflex-preview",action:"ready",payload:{url:window.location.href}},"*")}export{q as initPreviewMode};
