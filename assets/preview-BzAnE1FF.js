function I(){console.log("[Preview] Initialisation du mode Ã©diteur temps rÃ©el (FOCUS SAFE MODE)"),L(),C();const g={"palette.primary":"--primary-color","palette.secondary":"--secondary-color","palette.background":"--bg-color","palette.text":"--text-color","palette.accent":"--accent-color","palette.cardBackground":"--card-bg-color","palette.textMuted":"--text-muted-color","palette.cardBorder":"--card-border-color","palette.inputBackground":"--input-bg-color","palette.chatResponseBackground":"--chat-response-bg-color",primary:"--primary-color",secondary:"--secondary-color",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardBackground:"--card-bg-color","primary-color":"--primary-color","bg-color":"--bg-color","card-bg-color":"--card-bg-color"};function d(o){if(!o)return null;if(typeof o=="string"&&o.startsWith("--"))return o;const e=String(o).trim();if(g[e])return g[e];if(e==="layout.borderRadius")return"--border-radius";if(e==="typography.headingFont")return"--heading-font";if(e==="typography.bodyFont")return"--body-font";if(e==="header.style")return null;const r=e.replace(/^palette[\._-]?/i,"").replace(/\./g,"").replace(/_/g,"").toLowerCase(),a={primary:"--primary-color",primary600:"--primary-600",primary700:"--primary-700",secondary:"--secondary-color",secondary600:"--secondary-600",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardbackground:"--card-bg-color",textmuted:"--text-muted-color",cardborder:"--card-border-color",inputbackground:"--input-bg-color",chatresponsebackground:"--chat-response-bg-color",borderradius:"--border-radius",headingfont:"--heading-font",bodyfont:"--body-font"};return a[r]?a[r]:`--${e.replace(/^palette[\._-]?/i,"").replace(/\./g,"-").replace(/_/g,"-").toLowerCase()}`}function h(o={}){if(!o||typeof o!="object")return;const e=document.documentElement;Object.keys(o).forEach(r=>{const a=o[r];if(typeof a!="string"&&typeof a!="number")return;const n=r.startsWith("--")?r:d(r)||`--${r}`;e.style.setProperty(n,String(a))}),window.requestAnimationFrame(()=>{document.body.offsetHeight})}function w(o){const{sections:e}=o,r=document.querySelector('main[data-page-type="home"]');if(!r)return;console.log("[Preview] Reordering layout...",e);const a=Array.from(r.children).filter(t=>t.hasAttribute("data-zflex-section"));let n=!1;if(e.length!==a.length&&(n=!0),e.forEach(t=>{if(n)return;const s=r.querySelector(`[data-zflex-section="${t.type}"]`);s?(r.appendChild(s),s.style.animation="none",s.offsetHeight,s.style.animation="fadeIn 0.5s"):(console.log(`[Preview] Section missing: ${t.type} -> Reloading`),n=!0)}),n){console.log("[Preview] Layout structure changed (Add/Remove), reloading page...");const t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:9999;display:flex;justify-content:center;align-items:center;font-family:sans-serif;",t.innerHTML="<div style='background:white;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);'>Mise Ã  jour de la structure...</div>",document.body.appendChild(t),window.location.reload()}}function $(o){if(!o)return;const e=o.computed||{},r=o.palette||{},a={};Object.keys(r).forEach(n=>{const t=d(n)||d(`palette.${n}`)||`--${n}`;t&&(a[t]=r[n])}),Object.keys(e).forEach(n=>{const t=d(n)||`--${n.replace(/[A-Z]/g,s=>"-"+s.toLowerCase())}`;t&&(a[t]=e[n])}),h(a),console.log("[Preview] Applied computed palette vars:",a)}function v(o){if(o==null)return"";let e=String(o).trim();return/^[0-9A-Fa-f]{6}$/.test(e)&&(e="#"+e),e}function x(o){if(!o)return;let{property:e,value:r}=o;const a=d(e)||e,n=v(r);a&&(document.documentElement.style.setProperty(a,n),(a.includes("color")||a.includes("bg")||a.includes("background"))&&(document.body.style.transition="background-color 0.22s ease, color 0.22s ease, border-color 0.22s ease",setTimeout(()=>{document.body.style.transition=""},300)),console.log(`[Preview] Mise Ã  jour style (incoming: ${String(e)}) -> canonical: ${a}: ${n}`))}function A(o){if(!o)return;const{id:e,value:r}=o,a=document.querySelector(`[data-zflex-id="${e}"]`);if(!a){console.warn(`[Preview] Ã‰lÃ©ment introuvable : ${e}`);return}const n=a.tagName.toUpperCase();if(n==="IMG")a.src=r,a.alt||(a.alt="Image");else if(n==="I"||a.classList.contains("fa")||a.classList.contains("fas")||a.classList.contains("fab")||e.includes(".icon")){let t=String(r).trim();if(!t)return;!t.startsWith("fa-")&&!t.includes(" ")&&(t=`fa-${t}`),!t.includes("fas")&&!t.includes("fab")&&!t.includes("far")&&!t.includes("fal")&&(t=`fas ${t}`);const s=Array.from(a.classList).filter(i=>!i.startsWith("fa-")&&i!=="fas"&&i!=="fab"&&i!=="far"&&i!=="fa");a.className=`${s.join(" ")} ${t}`}else if(e.toLowerCase().includes("image")||e.includes("bg"))if(a.style.backgroundImage.includes("linear-gradient")){const t=a.style.backgroundImage.split(", url");a.style.backgroundImage=`${t[0]}, url('${r}')`}else a.style.backgroundImage=`url('${r}')`;else{const t=document.querySelectorAll(`[data-zflex-show="${e}"]`);if(t.length>0){const s=String(r)==="true"||r===!0;t.forEach(i=>{i.style.display=s?"":"none"}),s&&f(t[0]);return}/<[a-z][\s\S]*>/i.test(String(r))?a.innerHTML=String(r):a.textContent=String(r)}n!=="I"&&f(a)}function f(o){o&&(o.style.transition="transform 0.2s ease, outline 0.2s ease",o.style.outline="2px solid rgba(0, 229, 255, 0.5)",o.style.transform="scale(1.02)",o.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{o.style.transform="",o.style.outline=""},400))}function S(o){const{id:e}=o;let r=document.querySelector(`[data-zflex-section="${e.toLowerCase()}"]`)||document.querySelector(`[data-zflex-id="${e}"]`)||document.getElementById(e);r?f(r):console.log(`[Preview] Highlight: Element ${e} not found.`)}window.addEventListener("message",o=>{if(!o?.data)return;const e=o.data;if(e.source==="zflex-admin")switch(console.log("[Preview] Message reÃ§u de l'Ã©diteur:",e),e.action){case"updateElement":A(e.payload);break;case"updateStyle":x(e.payload);break;case"updatePalette":$(e.payload);break;case"updateRepeater":z(e.payload);break;case"updateVariant":E(e.payload);break;case"updateLayout":w(e.payload);break;case"highlight":S(e.payload);break;default:console.warn("[Preview] Action non reconnue:",e.action)}});function E(o){const{id:e,variant:r,data:a}=o,n=document.querySelector(`[data-zflex-variant-container="${e}"]`),t=document.querySelector(`template[data-zflex-variant="${e}.${r}"]`);if(!n||!t){console.warn(`[Preview] Impossible de changer le variant : ${e} -> ${r} (Template/Container missing)`);return}console.log(`[Preview] Swap variant ${e} vers ${r}`);const i=t.content.cloneNode(!0).firstElementChild;i&&(y(i,a,e),i.querySelectorAll("[data-zflex-repeater]").forEach(c=>{const u=c.getAttribute("data-zflex-repeater");if(!u)return;const l=u.split("."),k=l[l.length-1],b=a[k];Array.isArray(b)&&m(c,u,b)}),n.style.opacity="0",setTimeout(()=>{n.innerHTML="",n.appendChild(i),n.style.opacity="1"},150))}function m(o,e,r){const a=document.querySelector(`template[data-zflex-template="${e}"]`);a&&(o.innerHTML="",r.forEach((n,t)=>{const i=a.content.cloneNode(!0).firstElementChild;i&&(P(i,e,t),y(i,n,`${e}[${t}]`),o.appendChild(i))}))}function P(o,e,r){if(o.querySelectorAll("[data-zflex-bind]").forEach(n=>{const t=n.getAttribute("data-zflex-bind");n.setAttribute("data-zflex-id",`${e}[${r}].${t}`)}),o.hasAttribute("data-zflex-bind")){const n=o.getAttribute("data-zflex-bind");o.setAttribute("data-zflex-id",`${e}[${r}].${n}`)}}function y(o,e,r=""){const a=o.querySelectorAll("[data-zflex-bind]"),n=(t,s,i)=>{if(i==null)return;const p=t.tagName.toUpperCase();if(p==="IMG")t.src=String(i);else if(s==="icon"||t.tagName==="I"||t.classList.contains("fa")){let c=String(i).trim();if(c){!c.startsWith("fa-")&&!c.includes(" ")&&(c=`fa-${c}`),!c.includes("fas")&&!c.includes("fab")&&(c=`fas ${c}`);const u=Array.from(t.classList).filter(l=>!l.startsWith("fa")&&l!=="fas"&&l!=="fab");t.className=`${u.join(" ")} ${c}`}}else s.includes("image")||s.includes("bg")?p!=="IMG"&&(t.style.backgroundImage=`url('${i}')`):s==="image_position"?i==="left"?(t.classList.remove("image-right"),t.classList.add("image-left")):(t.classList.remove("image-left"),t.classList.add("image-right")):s==="style"&&t.classList.contains("reveal-section")?t.className=t.className.replace(/style-\w+/,`style-${i}`):t.textContent=String(i)};if(a.forEach(t=>{const s=t.getAttribute("data-zflex-bind");s&&n(t,s,e[s])}),o.hasAttribute("data-zflex-bind")){const t=o.getAttribute("data-zflex-bind");t&&n(o,t,e[t])}if(r.includes("reveal")&&e.image_position){const t=o.querySelector(".reveal-grid");t&&n(t,"image_position",e.image_position)}}function z(o){const{id:e,items:r}=o,a=document.querySelector(`[data-zflex-repeater="${e}"]`);a?(console.log(`[Preview] RÃ©gÃ©nÃ©ration du repeater ${e}`),m(a,e,r),a.style.transition="opacity 0.2s",a.style.opacity="0.5",setTimeout(()=>a.style.opacity="1",200)):console.warn(`[Preview] Repeater container not found: ${e}`)}function L(){console.log("[Preview] Activating Interaction Hijacking (Anti-Navigation)"),document.addEventListener("click",o=>{const e=o.target.closest("a, button, input[type='submit']");if(!e)return;if(e.classList.contains("btn-primary")||e.id.includes("add-to-cart")||e.textContent?.toLowerCase().includes("commander")||e.closest("#cart-btn")){o.preventDefault(),o.stopPropagation(),console.log("ðŸš« [Preview] Action commerciale bloquÃ©e:",e);return}if(e.tagName==="A"){const a=e.getAttribute("href");if(a&&a!=="#"&&!a.startsWith("javascript:")){o.preventDefault(),o.stopPropagation(),console.log("ðŸš« [Preview] Navigation bloquÃ©e:",a);return}}console.log("âœ… [Preview] Interaction autorisÃ©e:",e)},!0),document.addEventListener("submit",o=>{o.preventDefault(),o.stopPropagation(),console.log("ðŸš« [Preview] Soumission de formulaire bloquÃ©e.")},!0)}function C(){window.__ZFLEX_PREVIEW_MODE__=!0,console.log("ðŸš« [Preview] Analytics neutralized via Global Flag.")}window.parent!==window&&window.parent.postMessage({source:"zflex-preview",action:"ready",payload:{url:window.location.href}},"*")}export{I as initPreviewMode};
