function N(){console.log("[Preview] Initialisation du mode Ã©diteur temps rÃ©el (FOCUS V2 - LIVE ARCHITECTURE)");const g=new Map;function h(t,e){g.set(t,e),console.log(`[Preview] Update buffÃ©risÃ©e pour ${t} (Ã©lÃ©ment manquant)`)}function z(){if(g.size===0)return;console.log(`[Preview] Tentative de rejouer le buffer (${g.size} messages)...`);const t=Array.from(g.values());g.clear(),t.forEach(e=>{v({data:e})})}R(),M();const w={"palette.primary":"--primary-color","palette.secondary":"--secondary-color","palette.background":"--bg-color","palette.text":"--text-color","palette.accent":"--accent-color","palette.cardBackground":"--card-bg-color","palette.textMuted":"--text-muted-color","palette.cardBorder":"--card-border-color","palette.inputBackground":"--input-bg-color","palette.chatResponseBackground":"--chat-response-bg-color",primary:"--primary-color",secondary:"--secondary-color",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardBackground:"--card-bg-color","primary-color":"--primary-color","bg-color":"--bg-color","card-bg-color":"--card-bg-color"};function p(t){if(!t)return null;if(typeof t=="string"&&t.startsWith("--"))return t;const e=String(t).trim(),o={"layout.borderRadius":"--border-radius","typography.headingFont":"--heading-font","typography.bodyFont":"--body-font","header.style":""};if(o[e])return o[e]||null;if(w[e])return w[e];const a=e.replace(/^(palette|layout|typography)[\._-]?/i,"").replace(/\./g,"").replace(/_/g,"").toLowerCase(),i={primary:"--primary-color",primary600:"--primary-600",primary700:"--primary-700",secondary:"--secondary-color",secondary600:"--secondary-600",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardbackground:"--card-bg-color",textmuted:"--text-muted-color",cardborder:"--card-border-color",inputbackground:"--input-bg-color",chatresponsebackground:"--chat-response-bg-color",borderradius:"--border-radius",headingfont:"--heading-font",bodyfont:"--body-font"};return i[a]?i[a]:`--${e.replace(/^(palette|layout|typography)[\._-]?/i,"").replace(/\./g,"-").replace(/_/g,(r,s)=>s>0?"-":"").replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`}function P(t={}){if(!t||typeof t!="object")return;const e=document.documentElement;Object.keys(t).forEach(o=>{const a=t[o];if(typeof a!="string"&&typeof a!="number")return;const i=o.startsWith("--")?o:p(o)||`--${o}`;e.style.setProperty(i,String(a))}),window.requestAnimationFrame(()=>{document.body.offsetHeight})}function E(t){const{sections:e}=t,o=document.querySelector('main[data-zflex-page-type="home"]');if(!o)return;console.log("[Preview] Syncing layout...",e);const a=Array.from(o.children).filter(r=>r.hasAttribute("data-zflex-section")),i=e.map(r=>r.type);let n=[];if(a.forEach(r=>{const s=r.getAttribute("data-zflex-section");s&&!i.includes(s)&&(console.log(`[Preview] Removing section ${s}`),r.remove())}),e.forEach(r=>{const s=r.type,l=s.replace(/[A-Z]/g,d=>`_${d.toLowerCase()}`),c=o.querySelector(`[data-zflex-section="${s}"]`)||o.querySelector(`[data-zflex-section="${l}"]`);c?(o.appendChild(c),c.getAttribute("data-zflex-section")!==s&&c.setAttribute("data-zflex-section",s)):(console.log(`[Preview] Missing section ${s} (checked ${l} too)`),n.push(s))}),n.length>0){console.warn(`[Preview] ${n.length} sections missing. Waiting for live injection or artifact refresh...`);const r=sessionStorage.getItem("__zflex_last_reload"),s=Date.now();if(r&&s-parseInt(r)<15e3){console.error("ðŸš« [Preview] RELOAD GUARD ACTIVE: Reload loop detected. Aborting reload.");return}setTimeout(()=>{const l=n.filter(c=>{const d=c.replace(/[A-Z]/g,u=>`_${u.toLowerCase()}`);return!o.querySelector(`[data-zflex-section="${c}"]`)&&!o.querySelector(`[data-zflex-section="${d}"]`)});l.length>0?(console.log(`[Preview] ${l.length} sections still missing after 3s. Triggering safe reload.`),sessionStorage.setItem("__zflex_last_reload",s.toString()),window.location.reload()):console.log("[Preview] All sections finally arrived via injection. Reload averted.")},3e3)}}function I(t){const{type:e,html:o}=t,a=document.querySelector('main[data-zflex-page-type="home"]');if(!a)return;console.log(`[Preview] Injecting template for ${e}...`);const i=document.createElement("div");i.innerHTML=o.trim();const n=i.firstElementChild;if(n){n.setAttribute("data-zflex-section",e);const r=a.querySelector(`[data-zflex-section="${e}"]`);r?r.replaceWith(n):a.appendChild(n),console.log(`[Preview] Section ${e} injected successfully.`),n.style.animation="pulse-glow 1s ease-in-out",z()}}function C(t){if(!t)return;const e=t.computed||{},o=t.palette||{},a={};Object.keys(o).forEach(i=>{const n=p(i)||p(`palette.${i}`)||`--${i}`;n&&(a[n]=o[i])}),Object.keys(e).forEach(i=>{const n=p(i)||`--${i.replace(/[A-Z]/g,r=>"-"+r.toLowerCase())}`;n&&(a[n]=e[i])}),P(a),console.log("[Preview] Applied computed palette vars:",a)}function L(t){if(t==null)return"";let e=String(t).trim();return/^[0-9A-Fa-f]{6}$/.test(e)&&(e="#"+e),e}function $(t){if(!t)return;let{property:e,value:o}=t;const a=p(e)||e,i=L(o);a&&(document.documentElement.style.setProperty(a,i),(a.includes("color")||a.includes("bg")||a.includes("background"))&&(document.body.style.transition="background-color 0.22s ease, color 0.22s ease, border-color 0.22s ease",setTimeout(()=>{document.body.style.transition=""},300)),console.log(`[Preview] Mise Ã  jour style (incoming: ${String(e)}) -> canonical: ${a}: ${i}`))}function k(t,e){if(!t)return;const{id:o,value:a}=t,i=p(o);if(i&&(i.startsWith("--")||o.startsWith("palette.")||o.startsWith("layout.")||o.startsWith("typography."))&&($({property:o,value:a}),o.includes(".")&&(o.startsWith("palette")||o.startsWith("layout")||o.startsWith("typography"))))return;const n=document.querySelectorAll(`[data-zflex-show="${o}"]`);if(n.length>0){const l=String(a)==="true";n.forEach(c=>{c.style.setProperty("display",l?"":"none","important")})}if(o==="howItWorks.showIcons")return;const r=document.querySelector(`[data-zflex-id="${o}"]`);if(!r){e?h(o,e):n.length===0&&console.warn(`[Preview] Ã‰lÃ©ment introuvable : ${o}`);return}const s=r.tagName.toUpperCase();if(s==="IMG")r.src=a,r.alt||(r.alt="Image");else if(s==="I"||r.classList.contains("fa")||r.classList.contains("fas")||r.classList.contains("fab")||r.classList.contains("far")||r.classList.contains("fal")||o.includes(".icon")){let l=String(a).trim();if(!l)return;!l.startsWith("fa-")&&!l.includes(" ")&&(l=`fa-${l}`),!l.includes("fas")&&!l.includes("fab")&&!l.includes("far")&&!l.includes("fal")&&(l=`fas ${l}`);const c=Array.from(r.classList).filter(d=>!d.startsWith("fa-")&&d!=="fas"&&d!=="fab"&&d!=="far"&&d!=="fa");if(o.includes("features.items")){const d=r.closest(".feature-visual-wrapper");if(d){const u=d.querySelector(".feature-img-bind"),f=d.querySelector(".feature-icon-bind");if(u&&f){const y=!!a&&a!==""&&a!=="null",b=u,A=b.src&&!b.src.includes("undefined")&&!b.src.endsWith("/");u.style.display=A?"":"none",f.style.display=y&&!A?"":"none"}}}r.className=`${c.join(" ")} ${l}`}else if(o.toLowerCase().includes("image")||o.includes("bg")||o.includes("cover")){const l=r.style.backgroundImage;if(l&&l.includes("gradient")){const c=l.replace(/url\(['"]?.*?['"]?\)/,`url('${a}')`);r.style.backgroundImage=c}else r.style.backgroundImage=`url('${a}')`;if(o.includes("features.items")){const c=r.closest(".feature-visual-wrapper");if(c){const d=c.querySelector(".feature-img-bind"),u=c.querySelector(".feature-icon-bind");if(d&&u){const f=!!a&&a!==""&&a!=="null";d.style.display=f?"":"none",u.style.display=f?"none":""}}}}else{const l=document.querySelectorAll(`[data-zflex-show="${o}"]`);if(l.length>0){const c=String(a)==="true";l.forEach(d=>{d.style.setProperty("display",c?"":"none","important")}),c&&m(l[0]);return}/<[a-z][\s\S]*>/i.test(String(a))?r.innerHTML=String(a):r.textContent=String(a)}s!=="I"&&m(r)}function m(t){t&&(t.style.transition="transform 0.2s ease, outline 0.2s ease",t.style.outline="2px solid rgba(0, 229, 255, 0.5)",t.style.transform="scale(1.02)",t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{t.style.transform="",t.style.outline=""},400))}function q(t){const{id:e}=t;let o=document.querySelector(`[data-zflex-section="${e.toLowerCase()}"]`)||document.querySelector(`[data-zflex-id="${e}"]`)||document.getElementById(e);o?m(o):console.log(`[Preview] Highlight: Element ${e} not found.`)}function v(t){if(!t?.data)return;const e=t.data;if(e.source==="zflex-admin")switch(console.log("[Preview] Message reÃ§u de l'Ã©diteur:",e),e.action){case"updateElement":k(e.payload,e);break;case"updateStyle":$(e.payload);break;case"updatePalette":C(e.payload);break;case"updateRepeater":W(e.payload,e);break;case"updateVariant":_(e.payload);break;case"updateLayout":E(e.payload);break;case"highlight":q(e.payload);break;case"injectTemplate":I(e.payload);break;default:console.warn("[Preview] Action non reconnue:",e.action)}}window.addEventListener("message",v);function _(t){const{id:e,variant:o,data:a}=t,i=document.querySelector(`[data-zflex-variant-container="${e}"]`),n=document.querySelector(`template[data-zflex-variant="${e}.${o}"]`);if(!i||!n){console.warn(`[Preview] Impossible de changer le variant : ${e} -> ${o} (Template/Container missing)`);return}console.log(`[Preview] Swap variant ${e} vers ${o}`);const s=n.content.cloneNode(!0).firstElementChild;s&&(x(s,a,e),s.querySelectorAll("[data-zflex-repeater]").forEach(c=>{const d=c.getAttribute("data-zflex-repeater");if(!d)return;const u=d.split("."),f=u[u.length-1],y=a[f];Array.isArray(y)&&S(c,d,y)}),i.style.opacity="0",setTimeout(()=>{i.innerHTML="",i.appendChild(s),i.style.opacity="1"},150))}function S(t,e,o){const a=document.querySelector(`template[data-zflex-template="${e}"]`);a&&(t.innerHTML="",o.forEach((i,n)=>{const s=a.content.cloneNode(!0).firstElementChild;s&&(T(s,e,n),x(s,i,`${e}[${n}]`),t.appendChild(s))}))}function T(t,e,o){if(t.querySelectorAll("[data-zflex-bind]").forEach(i=>{const n=i.getAttribute("data-zflex-bind");i.setAttribute("data-zflex-id",`${e}[${o}].${n}`)}),t.hasAttribute("data-zflex-bind")){const i=t.getAttribute("data-zflex-bind");t.setAttribute("data-zflex-id",`${e}[${o}].${i}`)}}function x(t,e,o=""){const a=t.querySelectorAll("[data-zflex-bind]"),i=(n,r,s)=>{if(s==null)return;const l=n.tagName.toUpperCase();if(l==="IMG")n.src=String(s);else if(r==="icon"||n.tagName==="I"||n.classList.contains("fa")){let c=String(s).trim();if(c){!c.startsWith("fa-")&&!c.includes(" ")&&(c=`fa-${c}`),!c.includes("fas")&&!c.includes("fab")&&(c=`fas ${c}`);const d=Array.from(n.classList).filter(u=>!u.startsWith("fa")&&u!=="fas"&&u!=="fab");n.className=`${d.join(" ")} ${c}`}}else if(r.includes("image")||r.includes("bg")||r.includes("cover")){if(l!=="IMG"){const c=n.style.backgroundImage||window.getComputedStyle(n).backgroundImage;if(c&&c.includes("gradient")){const d=c.replace(/url\(['"]?.*?['"]?\)/,`url('${s}')`);n.style.backgroundImage=d}else n.style.backgroundImage=`url('${s}')`}}else r==="image_position"?s==="left"?(n.classList.remove("image-right"),n.classList.add("image-left")):(n.classList.remove("image-left"),n.classList.add("image-right")):r==="style"&&n.classList.contains("reveal-section")?n.className=n.className.replace(/style-\w+/,`style-${s}`):n.textContent=String(s)};if(a.forEach(n=>{const r=n.getAttribute("data-zflex-bind");r&&i(n,r,e[r])}),t.hasAttribute("data-zflex-bind")){const n=t.getAttribute("data-zflex-bind");n&&i(t,n,e[n])}if(o.includes("reveal")&&e.image_position){const n=t.querySelector(".reveal-grid");n&&i(n,"image_position",e.image_position)}}function W(t,e){const{id:o,items:a}=t,i=document.querySelector(`[data-zflex-repeater="${o}"]`);i?(console.log(`[Preview] RÃ©gÃ©nÃ©ration du repeater ${o}`),S(i,o,a),i.style.transition="opacity 0.2s",i.style.opacity="0.5",setTimeout(()=>i.style.opacity="1",200)):e?h(o,e):console.warn(`[Preview] Repeater container not found: ${o}`)}function R(){console.log("[Preview] Activating Interaction Hijacking (Anti-Navigation)"),document.addEventListener("click",t=>{const e=t.target.closest("a, button, input[type='submit']");if(!e)return;if(e.classList.contains("btn-primary")||e.id.includes("add-to-cart")||e.textContent?.toLowerCase().includes("commander")||e.closest("#cart-btn")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Action commerciale bloquÃ©e:",e);return}if(e.tagName==="A"){const a=e.getAttribute("href");if(a&&a!=="#"&&!a.startsWith("javascript:")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Navigation bloquÃ©e:",a);return}}console.log("âœ… [Preview] Interaction autorisÃ©e:",e)},!0),document.addEventListener("submit",t=>{t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Soumission de formulaire bloquÃ©e.")},!0)}function M(){window.__ZFLEX_PREVIEW_MODE__=!0,console.log("ðŸš« [Preview] Analytics neutralized via Global Flag.")}window.parent!==window&&window.parent.postMessage({source:"zflex-preview",action:"ready",payload:{url:window.location.href}},"*")}export{N as initPreviewMode};
